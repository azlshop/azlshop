<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ŸÖÿ™ÿ¨ÿ± ÿ£ÿ≤ŸÑ | azl MG shop</title>

<style>
:root{
  --bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--dark:#111827;--muted:#6b7280;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:#111}

header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--line)}
.wrap{max-width:1100px;margin:auto;padding:14px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.brand{font-weight:900}
.btn{
  border:1px solid var(--dark);background:var(--dark);color:#fff;
  border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer
}
.btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}
.muted{color:var(--muted);font-size:13px}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
@media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
.img{height:140px;background:#f3f4f6}
.p{padding:12px;display:grid;gap:10px}

select,input[type=file]{
  width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff
}

/* ===== CART (FIXED, NO FREEZE) ===== */
.drawer{position:fixed;inset:0;z-index:999999;display:none}
.drawer.open{display:block}
.drawer .back{position:absolute;inset:0;background:rgba(0,0,0,.45);z-index:1}
.drawer .panel{
  position:absolute;top:0;bottom:0;right:0;width:min(420px,92vw);
  background:#fff;z-index:2;overflow:auto;-webkit-overflow-scrolling:touch;
  border-inline-start:1px solid var(--line)
}
html[dir="ltr"] .drawer .panel{left:0;right:auto}
.hr{height:1px;background:var(--line);margin:10px 0}
.item{border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px}
.small{font-size:12px;color:var(--muted)}
</style>
</head>

<body>

<header>
  <div class="wrap row" style="justify-content:space-between">
    <div>
      <div class="brand" id="brand">ŸÖÿ™ÿ¨ÿ± ÿ£ÿ≤ŸÑ</div>
      <div class="muted" id="hint">ÿ£ÿ≠ÿØÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</div>
    </div>

    <div class="row">
      <button class="btn ghost" id="langBtn">EN</button>
      <button class="btn ghost" id="cartBtn">üõí <span id="count">0</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="row" id="cats"></div>
  <section class="grid" id="grid"></section>
</main>

<!-- CART -->
<aside class="drawer" id="drawer">
  <div class="back" onclick="closeCart()"></div>

  <div class="panel" role="dialog" aria-modal="true" aria-label="Cart">
    <div class="row" style="padding:14px;justify-content:space-between">
      <b id="cartTitle">ÿ≥ŸÑÿ™ŸÉ</b>
      <button class="btn ghost" type="button" onclick="closeCart()">‚úï</button>
    </div>
    <div class="hr"></div>

    <div id="items" style="padding:14px"></div>

    <div class="hr"></div>
    <div style="padding:14px">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <span id="totalLabel">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</span>
        <b id="total">AED 0.00</b>
      </div>

      <div class="row">
        <button class="btn" type="button" onclick="payNow()">ÿßÿØŸÅÿπ ÿßŸÑÿ¢ŸÜ</button>
        <button class="btn ghost" type="button" onclick="placeCOD()">ÿßŸÑÿØŸÅÿπ ÿπŸÜÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ (COD)</button>
      </div>

      <div class="muted" id="err" style="margin-top:10px"></div>
    </div>
  </div>
</aside>

<script>
/* ===== CONFIG ===== */
const WORKER_URL = "https://azlshop.eng-suwan.workers.dev";
const COD_WHATSAPP = "971544219984";

/* ===== I18N ===== */
const dict = {
  ar: {
    brand:"ŸÖÿ™ÿ¨ÿ± ÿ£ÿ≤ŸÑ", hint:"ÿ£ÿ≠ÿØÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™",
    all:"ÿßŸÑŸÉŸÑ", add:"ÿ£ÿ∂ŸÅ ŸÑŸÑÿ≥ŸÑÿ©",
    cart:"ÿ≥ŸÑÿ™ŸÉ", total:"ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
    pay:"ÿßÿØŸÅÿπ ÿßŸÑÿ¢ŸÜ", cod:"ÿßŸÑÿØŸÅÿπ ÿπŸÜÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ (COD)",
    size:"ÿßŸÑÿ≠ÿ¨ŸÖ", pieces:"ÿπÿØÿØ ÿßŸÑŸÇÿ∑ÿπ",
    upload:"ÿßÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ± ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©",
    mustMatch:"ÿπÿØÿØ ÿßŸÑÿµŸàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≥ÿßŸàŸä ÿπÿØÿØ ÿßŸÑŸÇÿ∑ÿπ",
    empty:"ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©",
    files:"ÿßŸÑÿµŸàÿ±",
    item:"ŸÖŸÜÿ™ÿ¨"
  },
  en: {
    brand:"azl MG shop", hint:"Latest products",
    all:"All", add:"Add to cart",
    cart:"Your cart", total:"Total",
    pay:"Pay now", cod:"Cash on Delivery (COD)",
    size:"Size", pieces:"Pieces",
    upload:"Upload print photos",
    mustMatch:"Number of photos must match pieces",
    empty:"Cart is empty",
    files:"Files",
    item:"Item"
  }
};

const $ = s => document.querySelector(s);
const state = {
  lang: localStorage.getItem("azl_lang") || ((navigator.language||"en").toLowerCase().startsWith("ar") ? "ar" : "en"),
  products: [],
  categories: [],
  cat: "all",
  cart: JSON.parse(localStorage.getItem("azl_cart") || "[]")
};

function t(k){ return dict[state.lang][k]; }
function money(x){ return `AED ${Number(x).toFixed(2)}`; }

function save(){
  localStorage.setItem("azl_lang", state.lang);
  localStorage.setItem("azl_cart", JSON.stringify(state.cart));
}

function showErr(msg){
  $("#err").textContent = msg || "";
}

/* ===== LOAD products.json ===== */
async function loadProducts(){
  const res = await fetch("/products.json", { cache:"no-store" });
  if(!res.ok) throw new Error("products.json HTTP " + res.status);
  const data = await res.json();
  state.products = Array.isArray(data.products) ? data.products : [];
  state.categories = Array.isArray(data.categories) ? data.categories : [];
}

/* ===== UI ===== */
function applyLang(){
  document.documentElement.lang = state.lang;
  document.documentElement.dir  = state.lang==="ar" ? "rtl" : "ltr";
  $("#brand").textContent = t("brand");
  $("#hint").textContent = t("hint");
  $("#cartTitle").textContent = t("cart");
  $("#totalLabel").textContent = t("total");
  $("#langBtn").textContent = state.lang==="ar" ? "EN" : "AR";
  showErr("");
}

function renderCats(){
  $("#cats").innerHTML =
    `<button class="btn ghost" onclick="setCat('all')">${t("all")}</button>` +
    state.categories.map(c =>
      `<button class="btn ghost" onclick="setCat('${c.id}')">${state.lang==="ar"?c.ar:c.en}</button>`
    ).join("");
}

function setCat(id){
  state.cat = id;
  renderProducts();
}

function renderProducts(){
  const list = state.cat==="all" ? state.products : state.products.filter(p => p.category===state.cat);

  $("#grid").innerHTML = list.map(p=>{
    const title = (p.name && (p.name[state.lang] || p.name.en)) || "-";

    if(p.type==="simple"){
      return `
      <article class="card">
        <div class="img"></div>
        <div class="p">
          <b>${title}</b>
          <div class="muted">${money(p.price || 0)}</div>
          <button class="btn ghost" onclick="addSimple('${p.id}')">${t("add")}</button>
        </div>
      </article>`;
    }

    // print_upload (Magnet)
    const sizeOptions = (p.sizes||[]).map(s =>
      `<option value="${s.id}">${state.lang==="ar"?s.label_ar:s.label_en}</option>`
    ).join("");

    const pieceOptions = (p.pieces||[]).map(n =>
      `<option value="${n}">${t("pieces")}: ${n}</option>`
    ).join("");

    return `
    <article class="card">
      <div class="img"></div>
      <div class="p">
        <b>${title}</b>

        <div class="small">${t("size")}</div>
        <select id="size_${p.id}">${sizeOptions}</select>

        <div class="small">${t("pieces")}</div>
        <select id="pieces_${p.id}" onchange="updatePriceLabel('${p.id}')">${pieceOptions}</select>

        <div class="small" id="price_${p.id}"></div>

        <div class="small">${t("upload")}</div>
        <input id="files_${p.id}" type="file" accept="image/*" multiple />

        <button class="btn ghost" onclick="addUpload('${p.id}')">${t("add")}</button>
      </div>
    </article>`;
  }).join("");

  // init prices
  list.forEach(p=>{ if(p.type==="print_upload") updatePriceLabel(p.id); });

  updateCartUI();
}

function updatePriceLabel(pid){
  const p = state.products.find(x=>x.id===pid);
  if(!p) return;
  const sizeId = document.getElementById(`size_${pid}`).value;
  const pcs = Number(document.getElementById(`pieces_${pid}`).value);
  const price = Number((p.pricing?.[sizeId]?.[String(pcs)]) || 0);
  document.getElementById(`price_${pid}`).textContent = `${money(price)}`;
}

/* ===== CART actions ===== */
function openCart(){ $("#drawer").classList.add("open"); }
function closeCart(){ $("#drawer").classList.remove("open"); }

function addSimple(id){
  const p = state.products.find(x=>x.id===id);
  if(!p) return;

  state.cart.push({
    key: `${id}|simple`,
    id,
    type:"simple",
    name: p.name,
    unitPrice: Number(p.price||0),
    qty: 1
  });

  save(); updateCartUI(); openCart();
}

function addUpload(id){
  showErr("");
  const p = state.products.find(x=>x.id===id);
  if(!p) return;

  const sizeId = document.getElementById(`size_${id}`).value;
  const pcs = Number(document.getElementById(`pieces_${id}`).value);
  const fileInput = document.getElementById(`files_${id}`);
  const files = fileInput ? Array.from(fileInput.files || []) : [];

  if(files.length !== pcs){
    showErr(t("mustMatch"));
    openCart();
    return;
  }

  const price = Number((p.pricing?.[sizeId]?.[String(pcs)]) || 0);

  // ŸÑÿß ŸÜÿ≥ÿ™ÿ∑Ÿäÿπ ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅÿßÿ™ File ŸÅŸä localStorage (ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸäŸÖŸÜÿπ)
  // ŸÑÿ∞ŸÑŸÉ ŸÜÿ≠ŸÅÿ∏ ŸÅŸÇÿ∑ ÿπÿØÿØŸáÿßÿå Ÿàÿ≥ÿ™ÿ±ŸèŸÅÿπ ŸÑÿßÿ≠ŸÇÿßŸã ÿ•ŸÑŸâ R2 ÿπŸÜÿØŸÖÿß ŸÜÿ∂ŸäŸÅ ÿÆÿ∑Ÿàÿ© ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±.
  state.cart.push({
    key: `${id}|${sizeId}|${pcs}|${Date.now()}`,
    id,
    type:"print_upload",
    name: p.name,
    unitPrice: price,
    qty: 1,
    options: { sizeId, pieces: pcs, filesCount: files.length },
    // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÜŸÅÿ≥Ÿáÿß ŸÑŸäÿ≥ÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ®ŸäŸÜ refresh
  });

  save(); updateCartUI(); openCart();
}

function updateCartUI(){
  $("#count").textContent = state.cart.reduce((s,i)=>s+Number(i.qty||0),0);
  const total = state.cart.reduce((s,i)=> s + (Number(i.unitPrice||0) * Number(i.qty||0)), 0);
  $("#total").textContent = money(total);

  const box = $("#items");
  if(!state.cart.length){
    box.innerHTML = `<div class="muted">${t("empty")}</div>`;
    return;
  }

  box.innerHTML = state.cart.map(i=>{
    const nm = (i.name && (i.name[state.lang] || i.name.en)) || t("item");
    let extra = "";
    if(i.type==="print_upload" && i.options){
      const sizeLabel =
        (i.options.sizeId==="5x5") ? (state.lang==="ar"?"5√ó5 ÿ≥ŸÖ":"5√ó5 cm") :
        (i.options.sizeId==="7x7") ? (state.lang==="ar"?"7√ó7 ÿ≥ŸÖ":"7√ó7 cm") :
        i.options.sizeId;

      extra = `<div class="small">‚Ä¢ ${t("size")}: ${sizeLabel} ‚Ä¢ ${t("pieces")}: ${i.options.pieces} ‚Ä¢ ${t("files")}: ${i.options.filesCount}/${i.options.pieces}</div>`;
    }
    return `
      <div class="item">
        <b>${nm}</b>
        ${extra}
        <div class="row" style="justify-content:space-between">
          <span class="muted">${money(i.unitPrice)} √ó ${i.qty}</span>
          <b>${money(i.unitPrice*i.qty)}</b>
        </div>
      </div>
    `;
  }).join("");
}

/* ===== PAY ===== */
async function payNow(){
  try{
    showErr("");
    if(!state.cart.length){ openCart(); return; }

    const items = state.cart.map(i=>({
      name: String(((i.name && (i.name[state.lang]||i.name.en)) || t("item"))),
      unit_amount: Number(i.unitPrice),
      quantity: Number(i.qty)
    }));

    const res = await fetch(`${WORKER_URL}/create-checkout-session`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ currency:"AED", lang: state.lang, items })
    });

    const text = await res.text();
    let data = {};
    try{ data = JSON.parse(text); } catch { data = { raw:text }; }

    if(!res.ok){
      showErr("Worker error: " + (data.error || data.raw || res.status));
      return;
    }
    if(!data.url){
      showErr("No checkout URL returned: " + JSON.stringify(data));
      return;
    }
    location.href = data.url;
  }catch(e){
    showErr("Payment error: " + (e?.message || e));
  }
}

function placeCOD(){
  const lines = state.cart.map(i=>{
    const nm = (i.name && (i.name[state.lang]||i.name.en)) || t("item");
    return `- ${nm} x${i.qty}`;
  }).join("\n");

  const msg = state.lang==="ar"
    ? `ÿ∑ŸÑÿ® COD ŸÖŸÜ ŸÖÿ™ÿ¨ÿ± ÿ£ÿ≤ŸÑ\n${lines}`
    : `COD order from azl MG shop\n${lines}`;

  window.open(`https://wa.me/${COD_WHATSAPP}?text=${encodeURIComponent(msg)}`,"_blank","noopener");
}

/* ===== EVENTS ===== */
document.getElementById("langBtn").addEventListener("click", ()=>{
  state.lang = state.lang==="ar" ? "en" : "ar";
  save(); applyLang(); renderCats(); renderProducts();
});
document.getElementById("cartBtn").addEventListener("click", openCart);

/* ===== BOOT ===== */
(async()=>{
  try{
    await loadProducts();
    applyLang();
    renderCats();
    renderProducts();
  }catch(e){
    applyLang();
    showErr("Load error: " + (e?.message || e));
    document.getElementById("grid").innerHTML = `<div class="muted">Load error: ${(e?.message||e)}</div>`;
  }
})();
</script>

</body>
</html>
