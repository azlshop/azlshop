<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ØªØ¬Ø± Ø£Ø²Ù„ | azl MG shop</title>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --line:#e6eaf0;
      --muted:#6b7280;
      --text:#0f172a;
      --dark:#111827;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    a{color:inherit}

    header{
      position:sticky;top:0;z-index:50;
      background:rgba(246,248,251,.85);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
    }
    .nav{
      max-width:1150px;margin:0 auto;padding:14px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .brandBox{display:flex;align-items:center;gap:10px}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background:linear-gradient(135deg,#111827,#334155);
      box-shadow: var(--shadow);
    }
    .brand{font-weight:900;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--dark);background:var(--dark);color:#fff;
      border-radius:999px;padding:10px 14px;cursor:pointer;
      font-weight:700;
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:#fff;color:var(--text);border:1px solid var(--line)}
    .small{padding:8px 10px;font-size:12px}
    .danger{border-color:#ef4444;color:#ef4444;background:#fff}

    main{max-width:1150px;margin:0 auto;padding:18px 14px 60px}
    .hero{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .hero h2{margin:0;font-size:16px}
    .hero p{margin:4px 0 0;color:var(--muted);font-size:13px;max-width:740px}
    .pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{
      background:#fff;border:1px solid var(--line);
      border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);
      display:flex;gap:6px;align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#22c55e}
    .dot2{width:8px;height:8px;border-radius:999px;background:#3b82f6}
    .dot3{width:8px;height:8px;border-radius:999px;background:#a855f7}

    .cats{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 14px}
    .cat{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .cat.active{background:var(--dark);color:#fff;border-color:var(--dark)}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      min-height:310px;
    }
    .img{
      height:140px;
      background:
        radial-gradient(120px 60px at 30% 30%, rgba(17,24,39,.12), transparent 60%),
        radial-gradient(140px 70px at 70% 60%, rgba(59,130,246,.10), transparent 65%),
        #eef2f7;
    }
    .content{padding:12px;display:grid;gap:10px}
    .title{font-weight:900}
    .price{font-weight:900}
    .muted{color:var(--muted);font-size:12px}
    select, input[type="number"], input[type="text"]{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
    }
    input[type="file"]{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px dashed #cbd5e1;
      background:#fff;
      outline:none;
    }
    .line{height:1px;background:var(--line);margin:6px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    /* Drawer (Cart) */
    .drawer{position:fixed;inset:0;pointer-events:none;z-index:9999}
    .drawer.open{pointer-events:auto}
    .back{
      position:absolute;inset:0;background:rgba(2,6,23,.45);
      opacity:0;transition:.2s;z-index:1;
    }
    .drawer.open .back{opacity:1}
    .panel{
      position:absolute;top:0;bottom:0;inset-inline-end:0;
      width:min(440px,94vw);
      background:#fff;border-inline-start:1px solid var(--line);
      transform:translateX(110%);transition:.22s;
      z-index:2;
      display:flex;flex-direction:column;
    }
    html[dir="ltr"] .panel{transform:translateX(-110%)}
    .drawer.open .panel{transform:translateX(0)}
    .p{padding:14px}
    .head{
      padding:14px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .body{
      padding:14px;overflow:auto;flex:1;
    }
    .foot{
      padding:14px;border-top:1px solid var(--line);
    }

    .cartItem{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
      margin-bottom:10px;
    }
    .cartTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .cartName{font-weight:900}
    .cartMeta{font-size:12px;color:var(--muted);margin-top:2px}
    .cartControls{
      display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap;
    }
    .qtyBox{display:flex;align-items:center;gap:8px}
    .qtyNum{min-width:30px;text-align:center;font-weight:900}
    .qtyInput{width:80px}
    .err{color:#ef4444;font-size:12px;margin-top:8px;display:none}
  </style>
</head>

<body>

<header>
  <div class="nav">
    <div class="brandBox">
      <div class="logo"></div>
      <div>
        <div class="brand" id="brand">Ù…ØªØ¬Ø± Ø£Ø²Ù„</div>
        <div class="sub" id="hint">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
      </div>
    </div>

    <div class="row">
      <button class="btn ghost" id="langBtn">EN</button>
      <button class="btn ghost" id="cartBtn">ğŸ›’ <span id="count">0</span></button>
    </div>
  </div>
</header>

<main>
  <section class="hero">
    <div>
      <h2 id="heroTitle">ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø³Ø±ÙŠØ¹Ø© ÙˆÙ…Ø±ØªØ¨Ø©</h2>
      <p id="heroDesc">Ø§Ø®ØªØ± Ù‚Ø³Ù…ØŒ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ Ø«Ù… Ø§Ø¯ÙØ¹ Ø¹Ø¨Ø± Stripe Ø£Ùˆ Ø§Ø·Ù„Ø¨ COD Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.</p>

      <div class="pills">
        <div class="pill"><span class="dot"></span><span id="pill1">Ø¯ÙØ¹ Ø¢Ù…Ù†</span></div>
        <div class="pill"><span class="dot2"></span><span id="pill2">COD Ù…ØªØ§Ø­</span></div>
        <div class="pill"><span class="dot3"></span><span id="pill3">Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span></div>
      </div>
    </div>

    <div class="cats" id="cats"></div>
  </section>

  <section class="grid" id="grid"></section>
</main>

<!-- CART -->
<aside class="drawer" id="drawer" aria-hidden="true">
  <div class="panel">
    <div class="head">
      <b id="cartTitle">Ø³Ù„ØªÙƒ</b>
      <button class="btn ghost" id="closeBtn">âœ•</button>
    </div>

    <div class="body">
      <div id="items"></div>
    </div>

    <div class="foot">
      <div class="row" style="justify-content:space-between">
        <span id="totalLabel">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
        <b id="total">AED 0.00</b>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="payBtn">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
        <button class="btn ghost" id="codBtn">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)</button>
      </div>

      <div class="err" id="err"></div>
    </div>
  </div>
  <div class="back" id="back"></div>
</aside>

<script>
  // ====== SETTINGS ======
  const WORKER_URL   = "https://azlshop.eng-suwan.workers.dev";
  const COD_WHATSAPP = "971544219984";

  // ====== I18N ======
  const dict = {
    ar: {
      brand:"Ù…ØªØ¬Ø± Ø£Ø²Ù„", hint:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
      heroTitle:"ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø³Ø±ÙŠØ¹Ø© ÙˆÙ…Ø±ØªØ¨Ø©",
      heroDesc:"Ø§Ø®ØªØ± Ù‚Ø³Ù…ØŒ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ Ø«Ù… Ø§Ø¯ÙØ¹ Ø¹Ø¨Ø± Stripe Ø£Ùˆ Ø§Ø·Ù„Ø¨ COD Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.",
      pill1:"Ø¯ÙØ¹ Ø¢Ù…Ù†", pill2:"COD Ù…ØªØ§Ø­", pill3:"Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ",
      all:"Ø§Ù„ÙƒÙ„",
      cart:"Ø³Ù„ØªÙƒ", total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
      pay:"Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†", cod:"Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)",
      add:"Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©",
      empty:"Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.",
      size:"Ø§Ù„Ø­Ø¬Ù…",
      pieces:"Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹",
      upload:"Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©",
      files:"Ø§Ù„ØµÙˆØ±",
      remove:"Ø­Ø°Ù",
      qty:"Ø§Ù„ÙƒÙ…ÙŠØ©",
      qtyEdit:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©",
      needFiles:"Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹",
      payErr:"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹: ",
      item:"Ù…Ù†ØªØ¬"
    },
    en: {
      brand:"azl MG shop", hint:"Latest products",
      heroTitle:"Clean & fast shopping experience",
      heroDesc:"Pick a category, add to cart, then pay via Stripe or order COD on WhatsApp.",
      pill1:"Secure payments", pill2:"COD available", pill3:"Auto Arabic/English",
      all:"All",
      cart:"Your cart", total:"Total",
      pay:"Pay now", cod:"Cash on Delivery (COD)",
      add:"Add to cart",
      empty:"Your cart is empty.",
      size:"Size",
      pieces:"Pieces",
      upload:"Upload print files",
      files:"Files",
      remove:"Remove",
      qty:"Qty",
      qtyEdit:"Edit quantity",
      needFiles:"Number of uploaded files must match pieces",
      payErr:"Payment error: ",
      item:"Item"
    }
  };

  // ====== HELPERS ======
  const $ = (s)=>document.querySelector(s);
  function detectDeviceLang(){
    const l = (navigator.language || "en").toLowerCase();
    return l.startsWith("ar") ? "ar" : "en";
  }

  // ====== DATA (EDIT PRICES LATER) ======
  const productsData = {
    categories: [
      { id:"print",  ar:"Ø·Ø¨Ø§Ø¹Ø©",   en:"Print"  },
      { id:"gifts",  ar:"Ù‡Ø¯Ø§ÙŠØ§",   en:"Gifts"  },
      { id:"frames", ar:"Ø¥Ø·Ø§Ø±Ø§Øª",  en:"Frames" },
      { id:"magnet", ar:"Ù…ØºÙ†Ø§Ø·ÙŠØ³", en:"Magnet" }
    ],
    products: [
      { id:"p1", category:"print",  name:{ar:"Ø·Ø¨Ø§Ø¹Ø© ØµÙˆØ±Ø©", en:"Photo Print"},   basePrice:49, type:"simple" },
      { id:"p2", category:"gifts",  name:{ar:"Ù‡Ø¯ÙŠØ© Ù…Ù…ÙŠØ²Ø©",  en:"Special Gift"}, basePrice:79, type:"simple" },
      { id:"p3", category:"frames", name:{ar:"Ø¥Ø·Ø§Ø± Ø­Ø§Ø¦Ø·",   en:"Wall Frame"},   basePrice:120,type:"simple" },

      // âœ… NEW MAGNET PRODUCT (REQUIRES UPLOAD)
      {
        id:"m1",
        category:"magnet",
        name:{ar:"ØµÙˆØ±Ø© Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠØ©", en:"Magnetic Photo"},
        type:"magnet_upload",
        options:{
          size:[
            { key:"5x5", ar:"5Ã—5 Ø³Ù…", en:"5Ã—5 cm" },
            { key:"7x7", ar:"7Ã—7 Ø³Ù…", en:"7Ã—7 cm" }
          ],
          pieces:[4,6,8,12]
        },
        // Ø£Ø³Ø¹Ø§Ø± Ù…Ø¤Ù‚ØªØ© (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§)
        pricing:{
          "5x5": { 4:39,  6:55,  8:69, 12:99 },
          "7x7": { 4:59,  6:79,  8:99, 12:139 }
        }
      }
    ]
  };

  // ====== STATE ======
  const state = {
    lang: localStorage.getItem("azl_lang") || detectDeviceLang(),
    activeCategory: "all",
    cart: JSON.parse(localStorage.getItem("azl_cart") || "[]"),
    // Ù†Ø­ØªÙØ¸ Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„ÙƒÙ„ Ø¹Ù†ØµØ± Ø¨Ø§Ù„Ø³Ù„Ø© (Ø­Ø³Ø¨ key)
    fileNamesByKey: JSON.parse(localStorage.getItem("azl_files") || "{}")
  };

  function t(k){ return dict[state.lang][k]; }
  function money(x){ return `AED ${Number(x).toFixed(2)}`; }
  function save(){
    localStorage.setItem("azl_lang", state.lang);
    localStorage.setItem("azl_cart", JSON.stringify(state.cart));
    localStorage.setItem("azl_files", JSON.stringify(state.fileNamesByKey));
  }
  function showErr(msg){
    const el = $("#err");
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
  }

  // ====== UI TEXT ======
  function applyLang(){
    document.documentElement.lang = state.lang;
    document.documentElement.dir  = state.lang==="ar" ? "rtl" : "ltr";

    $("#brand").textContent = t("brand");
    $("#hint").textContent  = t("hint");
    $("#heroTitle").textContent = t("heroTitle");
    $("#heroDesc").textContent  = t("heroDesc");
    $("#pill1").textContent = t("pill1");
    $("#pill2").textContent = t("pill2");
    $("#pill3").textContent = t("pill3");

    $("#cartTitle").textContent = t("cart");
    $("#totalLabel").textContent = t("total");
    $("#payBtn").textContent = t("pay");
    $("#codBtn").textContent = t("cod");
    $("#langBtn").textContent = state.lang==="ar" ? "EN" : "AR";
  }

  // ====== CATEGORIES ======
  function renderCategories(){
    const cats = productsData.categories;
    $("#cats").innerHTML = `
      <button class="cat ${state.activeCategory==="all" ? "active":""}" data-cat="all">${t("all")}</button>
      ${cats.map(c=>`
        <button class="cat ${state.activeCategory===c.id ? "active":""}" data-cat="${c.id}">
          ${state.lang==="ar"?c.ar:c.en}
        </button>
      `).join("")}
    `;

    $("#cats").querySelectorAll("[data-cat]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.activeCategory = btn.dataset.cat;
        renderCategories();
        renderProducts();
      });
    });
  }

  // ====== PRODUCT CARD RENDER ======
  function renderProducts(){
    const list = state.activeCategory==="all"
      ? productsData.products
      : productsData.products.filter(p=> p.category===state.activeCategory);

    $("#grid").innerHTML = list.map(p=>{
      if(p.type==="magnet_upload"){
        return renderMagnetCard(p);
      }
      return renderSimpleCard(p);
    }).join("");

    // bind simple add
    document.querySelectorAll("[data-add-simple]").forEach(b=>{
      b.addEventListener("click", ()=> addSimpleToCart(b.dataset.addSimple));
    });

    // bind magnet add + upload
    document.querySelectorAll("[data-add-magnet]").forEach(b=>{
      b.addEventListener("click", ()=> addMagnetToCart(b.dataset.addMagnet));
    });

    document.querySelectorAll("[data-upload]").forEach(inp=>{
      inp.addEventListener("change", (e)=> onUploadChange(e, inp.dataset.upload));
    });

    document.querySelectorAll("[data-size]").forEach(sel=>{
      sel.addEventListener("change", ()=> updateMagnetPrice(sel.dataset.size));
    });
    document.querySelectorAll("[data-pieces]").forEach(sel=>{
      sel.addEventListener("change", ()=> updateMagnetPrice(sel.dataset.pieces));
    });

    updateCartUI();
  }

  function renderSimpleCard(p){
    const name = p.name?.[state.lang] || p.name?.en || "-";
    return `
      <article class="card">
        <div class="img"></div>
        <div class="content">
          <div class="title">${name}</div>
          <div class="price">${money(p.basePrice || 0)}</div>
          <div class="muted">${p.category}</div>
          <div class="line"></div>
          <button class="btn ghost" data-add-simple="${p.id}">${t("add")}</button>
        </div>
      </article>
    `;
  }

  function renderMagnetCard(p){
    const name = p.name?.[state.lang] || p.name?.en || "-";
    const sizeOptions = p.options.size.map(s=>`
      <option value="${s.key}">${state.lang==="ar"?s.ar:s.en}</option>
    `).join("");
    const pieceOptions = p.options.pieces.map(n=>`<option value="${n}">${n}</option>`).join("");

    // default selections
    const defaultSize = p.options.size[0].key;
    const defaultPieces = p.options.pieces[0];
    const defaultPrice = (p.pricing?.[defaultSize]?.[defaultPieces]) ?? 0;

    return `
      <article class="card">
        <div class="img"></div>
        <div class="content">
          <div class="title">${name}</div>

          <div class="two">
            <div>
              <div class="muted">${t("size")}</div>
              <select data-size="${p.id}" id="size_${p.id}">
                ${sizeOptions}
              </select>
            </div>
            <div>
              <div class="muted">${t("pieces")}</div>
              <select data-pieces="${p.id}" id="pieces_${p.id}">
                ${pieceOptions}
              </select>
            </div>
          </div>

          <div class="price" id="price_${p.id}">${money(defaultPrice)}</div>

          <div>
            <div class="muted">${t("upload")}</div>
            <input type="file" multiple accept="image/*" data-upload="${p.id}" id="files_${p.id}" />
            <div class="muted" id="filesHint_${p.id}" style="margin-top:6px">0/${defaultPieces}</div>
          </div>

          <div class="line"></div>
          <button class="btn ghost" data-add-magnet="${p.id}">${t("add")}</button>
        </div>
      </article>
    `;
  }

  function updateMagnetPrice(productId){
    const p = productsData.products.find(x=>x.id===productId);
    if(!p) return;

    const sizeKey = document.getElementById(`size_${productId}`)?.value || p.options.size[0].key;
    const pieces  = Number(document.getElementById(`pieces_${productId}`)?.value || p.options.pieces[0]);

    const price = (p.pricing?.[sizeKey]?.[pieces]) ?? 0;
    const priceEl = document.getElementById(`price_${productId}`);
    if(priceEl) priceEl.textContent = money(price);

    const hint = document.getElementById(`filesHint_${productId}`);
    if(hint){
      const files = document.getElementById(`files_${productId}`)?.files?.length || 0;
      hint.textContent = `${files}/${pieces}`;
    }
  }

  // ====== CART ADD ======
  function addSimpleToCart(id){
    const p = productsData.products.find(x=>x.id===id);
    if(!p) return;
    const key = `${id}|simple`;
    const it = state.cart.find(x=>x.key===key);
    if(it) it.qty++;
    else state.cart.push({
      key,
      productId:id,
      name:p.name,
      qty:1,
      unitPrice:Number(p.basePrice||0),
      requires_uploads:false
    });
    save(); updateCartUI();
  }

  function onUploadChange(e, productId){
    // Ù†Ø­Ù† ÙÙ‚Ø· Ù†Ø®Ø²Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹)
    const files = Array.from(e.target.files || []);
    // Ù†Ø®Ø²Ù† Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ Ø¹Ù†ØµØ± Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ù†ØªØ¬ (Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© Ø³Ù†Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù€ item key)
    // Ù„Ø£Ø¬Ù„ Ø§Ù„Ø¨Ø³Ø§Ø·Ø©: Ù†Ø®Ø²Ù†Ù‡Ø§ Ø¨Ù…ÙØªØ§Ø­ "draft:productId"
    state.fileNamesByKey[`draft:${productId}`] = files.map(f=>f.name);
    save();

    updateMagnetPrice(productId);
  }

  function addMagnetToCart(id){
    const p = productsData.products.find(x=>x.id===id);
    if(!p) return;

    const sizeKey = document.getElementById(`size_${id}`)?.value;
    const pieces  = Number(document.getElementById(`pieces_${id}`)?.value || 0);

    const sizeObj = p.options.size.find(s=>s.key===sizeKey);
    const sizeLabel = state.lang==="ar" ? sizeObj.ar : sizeObj.en;

    const price = (p.pricing?.[sizeKey]?.[pieces]) ?? 0;

    // ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ù„ÙØ§Øª
    const draftFiles = state.fileNamesByKey[`draft:${id}`] || [];
    if(draftFiles.length !== pieces){
      alert(t("needFiles"));
      return;
    }

    // key ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ù…+Ø§Ù„Ù‚Ø·Ø¹ (Ø­ØªÙ‰ ÙŠÙƒÙˆÙ† Ø¹Ù†ØµØ± Ù…Ø®ØªÙ„Ù)
    const key = `${id}|${sizeKey}|${pieces}`;
    const it = state.cart.find(x=>x.key===key);
    if(it){
      it.qty++;
    } else {
      state.cart.push({
        key,
        productId:id,
        name:p.name,
        qty:1,
        unitPrice:Number(price),
        requires_uploads:true,
        size:sizeLabel,
        pieces:pieces
      });
    }

    // Ø§Ø±Ø¨Ø· Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ù„Ø©
    state.fileNamesByKey[key] = draftFiles;

    // Ø§Ù…Ø³Ø­ draft
    delete state.fileNamesByKey[`draft:${id}`];
    const input = document.getElementById(`files_${id}`);
    if(input) input.value = "";

    save(); updateCartUI();
    openCart();
  }

  // ====== CART UI (WITH + / - / REMOVE + INPUT) ======
  function updateCartUI(){
    $("#count").textContent = state.cart.reduce((s,i)=> s + Number(i.qty||0), 0);
    const total = state.cart.reduce((s,i)=> s + (Number(i.unitPrice||0) * Number(i.qty||0)), 0);
    $("#total").textContent = money(total);

    const box = $("#items");
    if(!state.cart.length){
      box.innerHTML = `<div class="muted">${t("empty")}</div>`;
      return;
    }

    box.innerHTML = state.cart.map(i=>{
      const name = (i.name?.[state.lang] || i.name?.en || t("item"));

      const meta = [];
      if(i.size) meta.push(`${t("size")}: ${i.size}`);
      if(i.pieces) meta.push(`${t("pieces")}: ${i.pieces}`);

      if(i.requires_uploads){
        const fn = state.fileNamesByKey[i.key] || [];
        meta.push(`${t("files")}: ${fn.length}/${i.pieces || 0}`);
      }

      return `
        <div class="cartItem" data-key="${i.key}">
          <div class="cartTop">
            <div>
              <div class="cartName">${name}</div>
              ${meta.length ? `<div class="cartMeta">${meta.join(" â€¢ ")}</div>` : ``}
            </div>
            <div style="text-align:end">
              <div style="font-weight:900">${money(Number(i.unitPrice||0) * Number(i.qty||0))}</div>
              <div class="muted">${money(Number(i.unitPrice||0))} Ã— ${Number(i.qty||0)}</div>
            </div>
          </div>

          <div class="cartControls">
            <div class="qtyBox" title="${t("qtyEdit")}">
              <button class="btn ghost small" data-dec="${i.key}">âˆ’</button>
              <div class="qtyNum">${Number(i.qty||0)}</div>
              <button class="btn ghost small" data-inc="${i.key}">+</button>

              <!-- âœ… input Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ÙƒÙ…ÙŠØ© -->
              <input class="qtyInput" type="number" min="1" step="1" value="${Number(i.qty||0)}" data-q="${i.key}" />
            </div>

            <button class="btn ghost small danger" data-rm="${i.key}">
              ${t("remove")}
            </button>
          </div>
        </div>
      `;
    }).join("");

    // events
    box.querySelectorAll("[data-inc]").forEach(b=>{
      b.addEventListener("click", ()=> changeQty(b.dataset.inc, +1));
    });
    box.querySelectorAll("[data-dec]").forEach(b=>{
      b.addEventListener("click", ()=> changeQty(b.dataset.dec, -1));
    });
    box.querySelectorAll("[data-rm]").forEach(b=>{
      b.addEventListener("click", ()=> removeItem(b.dataset.rm));
    });
    box.querySelectorAll("[data-q]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const v = Number(inp.value || 1);
        setQty(inp.dataset.q, v);
      });
    });
  }

  function changeQty(key, delta){
    const it = state.cart.find(x=>x.key===key);
    if(!it) return;
    it.qty = Number(it.qty||0) + delta;
    if(it.qty <= 0){ removeItem(key); return; }
    save(); updateCartUI();
  }

  function setQty(key, value){
    const it = state.cart.find(x=>x.key===key);
    if(!it) return;
    const v = Math.max(1, Math.floor(Number(value||1)));
    it.qty = v;
    save(); updateCartUI();
  }

  function removeItem(key){
    state.cart = state.cart.filter(x=>x.key !== key);
    delete state.fileNamesByKey[key];
    save(); updateCartUI();
  }

  // ====== DRAWER ======
  function openCart(){ $("#drawer").classList.add("open"); }
  function closeCart(){ $("#drawer").classList.remove("open"); }

  // ====== PAY ======
  async function payNow(){
    try{
      showErr("");
      if(!state.cart.length){ openCart(); return; }

      // ØªØ­Ù‚Ù‚ Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³: Ù…Ù„ÙØ§Øª Ù…Ø·Ù„ÙˆØ¨Ø©
      for(const i of state.cart){
        if(i.requires_uploads){
          const fn = state.fileNamesByKey[i.key] || [];
          if(fn.length !== Number(i.pieces||0)){
            throw new Error(t("needFiles"));
          }
        }
      }

      const items = state.cart.map(i=>{
        const baseName = (i.name?.[state.lang] || i.name?.en || t("item"));
        const opt = [];
        if(i.size) opt.push(`${t("size")}: ${i.size}`);
        if(i.pieces) opt.push(`${t("pieces")}: ${i.pieces}`);
        if(i.requires_uploads) opt.push(`${t("files")}: ${(state.fileNamesByKey[i.key]||[]).length}/${i.pieces}`);

        const fullName = opt.length ? `${baseName} â€” ${opt.join(" â€” ")}` : baseName;

        return {
          name: String(fullName),
          unit_amount: Number(i.unitPrice),
          quantity: Number(i.qty)
        };
      });

      const res = await fetch(`${WORKER_URL}/create-checkout-session`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ currency:"AED", lang: state.lang, items })
      });

      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); } catch { data = { raw:text }; }

      if(!res.ok){
        throw new Error(data.error || data.raw || ("Worker error " + res.status));
      }
      if(!data.url) throw new Error("No checkout URL returned");

      location.href = data.url;
    } catch(e){
      const msg = (e?.message || e);
      showErr(t("payErr") + msg);
      alert(t("payErr") + msg);
    }
  }

  function placeCOD(){
    // message for WhatsApp
    const lines = state.cart.map(i=>{
      const name = (i.name?.[state.lang] || i.name?.en || t("item"));
      const parts = [];
      if(i.size) parts.push(`${t("size")}: ${i.size}`);
      if(i.pieces) parts.push(`${t("pieces")}: ${i.pieces}`);
      return `- ${name}${parts.length?` (${parts.join(", ")})`:""} x${i.qty} = ${money(i.unitPrice*i.qty)}`;
    }).join("\n");

    const total = state.cart.reduce((s,i)=> s + (Number(i.unitPrice||0)*Number(i.qty||0)), 0);

    const msg = state.lang==="ar"
      ? `Ø·Ù„Ø¨ COD Ù…Ù† Ù…ØªØ¬Ø± Ø£Ø²Ù„\n\n${lines}\n\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${money(total)}`
      : `COD order from azl MG shop\n\n${lines}\n\nTotal: ${money(total)}`;

    window.open(`https://wa.me/${COD_WHATSAPP}?text=${encodeURIComponent(msg)}`,"_blank","noopener");
  }

  // ====== EVENTS ======
  $("#langBtn").addEventListener("click", ()=>{
    state.lang = state.lang==="ar" ? "en" : "ar";
    save();
    applyLang();
    renderCategories();
    renderProducts();
  });

  $("#cartBtn").addEventListener("click", openCart);
  $("#back").addEventListener("click", closeCart);
  $("#closeBtn").addEventListener("click", closeCart);

  $("#payBtn").addEventListener("click", payNow);
  $("#codBtn").addEventListener("click", placeCOD);

  // ====== BOOT ======
  (function boot(){
    applyLang();
    renderCategories();
    renderProducts();
    updateCartUI();
  })();
</script>

</body>
</html>
