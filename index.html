<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù…ØªØ¬Ø± Ø£Ø²Ù„ | azl MG shop</title>

<style>
:root{
  --bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--dark:#111827;--muted:#6b7280;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:#111}

header{
  position:sticky;top:0;z-index:20;
  background:#fff;border-bottom:1px solid var(--line)
}
.wrap{max-width:1100px;margin:auto;padding:14px}

.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{
  border:1px solid var(--dark);background:var(--dark);color:#fff;
  border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer
}
.btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
@media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}

.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:16px;overflow:hidden
}
.img{height:140px;background:#f3f4f6}
.p{padding:12px;display:grid;gap:8px}
.muted{color:var(--muted);font-size:13px}

select,input[type=file]{
  width:100%;padding:10px;border-radius:12px;border:1px solid var(--line)
}

/* CART */
.drawer{position:fixed;inset:0;pointer-events:none;z-index:9999}
.drawer.open{pointer-events:auto}
.back{
  position:absolute;inset:0;background:rgba(0,0,0,.4);
}
.panel{
  position:absolute;top:0;bottom:0;inset-inline-end:0;
  width:min(420px,92vw);background:#fff;
  transform:translateX(110%);transition:.25s;
  border-inline-start:1px solid var(--line);
}
.drawer.open .panel{transform:translateX(0)}
html[dir="ltr"] .panel{transform:translateX(-110%)}

.head,.foot{padding:14px;border-bottom:1px solid var(--line)}
.body{padding:14px;overflow:auto;height:calc(100vh - 220px)}

.item{border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px}

/* ğŸ”§ FIX: Ù„Ø§ Ø´ÙŠØ¡ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· */
.panel{pointer-events:auto}
.back{pointer-events:auto}
</style>
</head>

<body>

<header>
  <div class="wrap row" style="justify-content:space-between">
    <b id="brand">Ù…ØªØ¬Ø± Ø£Ø²Ù„</b>
    <div class="row">
      <button class="btn ghost" id="langBtn">EN</button>
      <button class="btn ghost" id="cartBtn">ğŸ›’ <span id="count">0</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="row" id="cats"></div>
  <section class="grid" id="grid"></section>
</main>

<!-- CART -->
<aside class="drawer" id="drawer">
  <div class="panel">
    <div class="head row" style="justify-content:space-between">
      <b id="cartTitle">Ø³Ù„ØªÙƒ</b>
      <button class="btn ghost" onclick="closeCart()">âœ•</button>
    </div>

    <div class="body" id="items"></div>

    <div class="foot">
      <div class="row" style="justify-content:space-between">
        <span id="totalLabel">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
        <b id="total">AED 0.00</b>
      </div>

      <!-- âœ… Ø²Ø± Ø§Ù„Ø¯ÙØ¹ Ù…Ø¹ onclick Ù…Ø¨Ø§Ø´Ø± -->
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="payNow()">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
        <button class="btn ghost" onclick="placeCOD()">COD</button>
      </div>

      <div class="muted" id="err" style="margin-top:8px"></div>
    </div>
  </div>
  <div class="back" onclick="closeCart()"></div>
</aside>

<script>
/* ===== CONFIG ===== */
const WORKER_URL="https://azlshop.eng-suwan.workers.dev";
const COD_WHATSAPP="971544219984";

/* ===== LANG ===== */
const dict={
  ar:{brand:"Ù…ØªØ¬Ø± Ø£Ø²Ù„",cart:"Ø³Ù„ØªÙƒ",total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",add:"Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©",all:"Ø§Ù„ÙƒÙ„"},
  en:{brand:"azl MG shop",cart:"Your cart",total:"Total",add:"Add to cart",all:"All"}
};
const state={
  lang:(navigator.language||"en").startsWith("ar")?"ar":"en",
  cart:[],
  products:[],
  categories:[],
  cat:"all"
};
const $=s=>document.querySelector(s);
const t=k=>dict[state.lang][k];
const money=x=>`AED ${Number(x).toFixed(2)}`;

/* ===== LOAD PRODUCTS ===== */
async function loadProducts(){
  const res=await fetch("/products.json",{cache:"no-store"});
  const data=await res.json();
  state.products=data.products||[];
  state.categories=data.categories||[];
}

/* ===== UI ===== */
function applyLang(){
  document.documentElement.lang=state.lang;
  document.documentElement.dir=state.lang==="ar"?"rtl":"ltr";
  $("#brand").textContent=t("brand");
  $("#cartTitle").textContent=t("cart");
  $("#totalLabel").textContent=t("total");
  $("#langBtn").textContent=state.lang==="ar"?"EN":"AR";
}

function renderCats(){
  $("#cats").innerHTML=
    `<button class="btn ghost" onclick="setCat('all')">${t("all")}</button>`+
    state.categories.map(c=>
      `<button class="btn ghost" onclick="setCat('${c.id}')">${state.lang==="ar"?c.ar:c.en}</button>`
    ).join("");
}

function setCat(id){state.cat=id;renderProducts();}

function renderProducts(){
  const list=state.cat==="all"?state.products:state.products.filter(p=>p.category===state.cat);
  $("#grid").innerHTML=list.map(p=>`
    <div class="card">
      <div class="img"></div>
      <div class="p">
        <b>${p.name[state.lang]}</b>
        ${p.type==="simple"
          ? `<div>${money(p.price)}</div>`
          : `<select id="size_${p.id}">
              ${p.sizes.map(s=>`<option value="${s.id}">${state.lang==="ar"?s.label_ar:s.label_en}</option>`).join("")}
            </select>
            <select id="pieces_${p.id}">
              ${p.pieces.map(n=>`<option value="${n}">${n}</option>`).join("")}
            </select>
            <input type="file" id="files_${p.id}" multiple>`
        }
        <button class="btn ghost" onclick="addToCart('${p.id}')">${t("add")}</button>
      </div>
    </div>
  `).join("");
}

/* ===== CART ===== */
function openCart(){$("#drawer").classList.add("open")}
function closeCart(){$("#drawer").classList.remove("open")}

function addToCart(id){
  const p=state.products.find(x=>x.id===id);
  if(!p)return;

  let price=p.price||0;
  let options=null;
  let files=[];

  if(p.type==="print_upload"){
    const sizeId=$("#size_"+id).value;
    const pcs=Number($("#pieces_"+id).value);
    files=[...$("#files_"+id).files];
    if(files.length!==pcs){
      $("#err").textContent="Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹";
      openCart();return;
    }
    const sizeObj=p.sizes.find(s=>s.id===sizeId);
    price=sizeObj.prices[String(pcs)];
    options={size:sizeId,pieces:pcs};
  }

  state.cart.push({id,name:p.name,price,qty:1,options,files});
  updateCart();openCart();
}

function updateCart(){
  $("#count").textContent=state.cart.length;
  const total=state.cart.reduce((s,i)=>s+i.price*i.qty,0);
  $("#total").textContent=money(total);
  $("#items").innerHTML=state.cart.map(i=>`
    <div class="item">
      <b>${i.name[state.lang]}</b>
      <div class="muted">${money(i.price)}</div>
    </div>
  `).join("");
}

/* ===== PAY ===== */
function payNow(){
  alert("Ø²Ø± Ø§Ù„Ø¯ÙØ¹ ÙŠØ¹Ù…Ù„ âœ…"); // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
  if(!state.cart.length){openCart();return;}
  fetch(WORKER_URL+"/create-checkout-session",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      currency:"AED",
      items:state.cart.map(i=>({
        name:i.name[state.lang],
        unit_amount:i.price,
        quantity:i.qty
      }))
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.url)location.href=d.url;
    else alert("Stripe error");
  });
}

function placeCOD(){
  const msg="Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ØªØ¬Ø± Ø£Ø²Ù„";
  window.open(`https://wa.me/${COD_WHATSAPP}?text=${encodeURIComponent(msg)}`,"_blank");
}

/* ===== EVENTS ===== */
$("#langBtn").onclick=()=>{
  state.lang=state.lang==="ar"?"en":"ar";
  applyLang();renderCats();renderProducts();
};
$("#cartBtn").onclick=openCart;

/* ===== BOOT ===== */
(async()=>{
  await loadProducts();
  applyLang();renderCats();renderProducts();
})();
</script>
</body>
</html>
