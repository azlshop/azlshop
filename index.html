<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ØªØ¬Ø± Ø£Ø²Ù„ | azl MG shop</title>

  <style>
    :root{
      --line:#e5e7eb;--muted:#6b7280;--dark:#111827;
      --bg:#f8fafc;--card:#ffffff;--soft:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 14px;z-index:10}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{font-weight:900}
    .btn{
      border:1px solid var(--dark);
      background:var(--dark);
      color:#fff;
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      touch-action:manipulation;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .small{padding:8px 10px;font-size:13px}
    .danger{border-color:#ef4444;color:#ef4444;background:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:13px}

    /* hero */
    .hero{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
      display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{border:1px solid var(--line);background:var(--soft);padding:6px 10px;border-radius:999px;font-size:12px}
    .dot{display:inline-block;width:8px;height:8px;border-radius:999px;background:#22c55e;margin-inline-end:6px}

    /* categories */
    #cats{margin-bottom:12px}
    #cats .btn{background:#fff;color:#111;border:1px solid var(--line)}
    #cats .btn.active{background:var(--dark);color:#fff;border-color:var(--dark)}

    /* products */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      display:flex;flex-direction:column;
      min-height:320px;
      box-shadow:0 10px 25px rgba(17,24,39,.06);
    }
    .img{height:140px;background:linear-gradient(135deg,#f3f4f6,#e5e7eb)}
    .p{padding:12px;display:grid;gap:10px}
    .price{font-weight:900}
    select,input[type="number"],input[type="file"]{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
    }
    label{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:6px 0}

    /* ====== Drawer FIX (Ø§Ù„Ø£Ù‡Ù…) ====== */
    .drawer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:9999;
    }
    .drawer.open{pointer-events:auto}

    /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© */
    .back{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.35);
      opacity:0;
      transition:.2s;
      z-index:1;            /* Ø£Ù‚Ù„ Ù…Ù† panel */
      pointer-events:auto;  /* ØªØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ø³Ù„Ø© */
    }
    .drawer.open .back{opacity:1}

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ù„Ø© */
    .panel{
      position:absolute;
      inset-inline-end:0;
      top:0;bottom:0;
      width:min(420px,92vw);
      background:#fff;
      border-inline-start:1px solid var(--line);
      transform:translateX(110%);
      transition:.2s;
      z-index:2;           /* Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© */
      pointer-events:auto; /* Ù…Ù‡Ù…: ØªØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ· */
      display:flex;
      flex-direction:column;
    }
    html[dir="ltr"] .panel{transform:translateX(-110%)}
    .drawer.open .panel{transform:translateX(0)}

    .head{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .body{padding:14px;overflow:auto;flex:1}
    .foot{padding:14px;border-top:1px solid var(--line)}

    .cartItem{border:1px solid var(--line);border-radius:14px;padding:10px;margin-bottom:10px;background:#fff}
    .cartTop{display:flex;justify-content:space-between;gap:10px}
    .cartName{font-weight:900}
    .cartMeta{font-size:12px;color:var(--muted);margin-top:4px}
    .cartControls{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px}
    .qtyBox{display:flex;align-items:center;gap:8px}
    .qtyInput{
      width:78px;
      padding:8px;
      border-radius:12px;
      border:1px solid var(--line);
      text-align:center;
      font-weight:700;
    }
    .err{margin-top:10px;color:#b91c1c;font-size:13px}
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand" id="brand">Ù…ØªØ¬Ø± Ø£Ø²Ù„</div>
    <div class="row">
      <button class="btn ghost" id="langBtn">EN</button>
      <button class="btn ghost" id="cartBtn">ğŸ›’ <span id="count">0</span></button>
    </div>
  </div>
  <div class="muted" id="hint" style="margin-top:10px">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
</header>

<main class="wrap">
  <section class="hero">
    <div>
      <div style="font-weight:900" id="heroTitle">ØªØ¬Ø±Ø¨Ø© Ø´Ø±Ø§Ø¡ Ø³Ø±ÙŠØ¹Ø© ÙˆÙ†Ø¸ÙŠÙØ©</div>
      <div class="muted" id="heroSub">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…ØŒ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ ÙˆØ§Ø¯ÙØ¹ Ø¹Ø¨Ø± Stripe Ø£Ùˆ Ø§Ø·Ù„Ø¨ COD ÙˆØ§ØªØ³Ø§Ø¨.</div>
      <div class="badges" style="margin-top:10px">
        <div class="badge"><span class="dot"></span><span id="b1">Ø¯ÙØ¹ Ø¢Ù…Ù†</span></div>
        <div class="badge"><span class="dot"></span><span id="b2">COD Ù…ØªØ§Ø­</span></div>
        <div class="badge"><span class="dot"></span><span id="b3">Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span></div>
      </div>
    </div>
  </section>

  <div class="row" id="cats"></div>
  <section class="grid" id="grid"></section>
</main>

<aside class="drawer" id="drawer" aria-hidden="true">
  <!-- panel Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… back (Ù…Ø¹ z-index ØµØ­ÙŠØ­) -->
  <div class="panel" id="panel">
    <div class="head">
      <b id="cartTitle">Ø³Ù„ØªÙƒ</b>
      <button class="btn ghost" id="closeBtn">âœ•</button>
    </div>

    <div class="body">
      <div id="items"></div>
      <div class="err" id="err" style="display:none"></div>
    </div>

    <div class="foot">
      <div class="row" style="justify-content:space-between">
        <span id="totalLabel">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
        <b id="total">AED 0.00</b>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="payBtn">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
        <button class="btn ghost" id="codBtn">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)</button>
      </div>

      <div class="muted" style="margin-top:10px" id="note">
        Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹.
      </div>
    </div>
  </div>

  <div class="back" id="back"></div>
</aside>

<script>
  const WORKER_URL = "https://azlshop.eng-suwan.workers.dev";
  const COD_WHATSAPP = "971544219984";

  const dict = {
    ar: {
      brand:"Ù…ØªØ¬Ø± Ø£Ø²Ù„",
      hint:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
      heroTitle:"ØªØ¬Ø±Ø¨Ø© Ø´Ø±Ø§Ø¡ Ø³Ø±ÙŠØ¹Ø© ÙˆÙ†Ø¸ÙŠÙØ©",
      heroSub:"Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…ØŒ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ ÙˆØ§Ø¯ÙØ¹ Ø¹Ø¨Ø± Stripe Ø£Ùˆ Ø§Ø·Ù„Ø¨ COD ÙˆØ§ØªØ³Ø§Ø¨.",
      b1:"Ø¯ÙØ¹ Ø¢Ù…Ù†", b2:"COD Ù…ØªØ§Ø­", b3:"Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ",
      all:"Ø§Ù„ÙƒÙ„",
      cart:"Ø³Ù„ØªÙƒ",
      total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
      pay:"Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†",
      cod:"Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)",
      add:"Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©",
      remove:"Ø­Ø°Ù",
      empty:"Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.",
      size:"Ø§Ù„Ø­Ø¬Ù…",
      pieces:"Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹",
      upload:"Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©",
      files:"Ø§Ù„ØµÙˆØ±",
      needFiles:"ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ± Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹.",
      qty:"Ø§Ù„ÙƒÙ…ÙŠØ©",
      note:"Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹."
    },
    en: {
      brand:"azl MG shop",
      hint:"Latest products",
      heroTitle:"Clean & fast shopping experience",
      heroSub:"Pick a category, add to cart, pay via Stripe or order COD on WhatsApp.",
      b1:"Secure payments", b2:"COD available", b3:"Auto Arabic/English",
      all:"All",
      cart:"Your cart",
      total:"Total",
      pay:"Pay now",
      cod:"Cash on Delivery (COD)",
      add:"Add to cart",
      remove:"Remove",
      empty:"Your cart is empty.",
      size:"Size",
      pieces:"Pieces",
      upload:"Upload photos for printing",
      files:"Files",
      needFiles:"You must upload files equal to pieces before paying.",
      qty:"Qty",
      note:"Number of files must match pieces."
    }
  };

  const $ = (s)=>document.querySelector(s);

  function detectDeviceLang(){
    const l = (navigator.language || "en").toLowerCase();
    return l.startsWith("ar") ? "ar" : "en";
  }

  const state = {
    lang: localStorage.getItem("azl_lang") || detectDeviceLang(),
    cart: JSON.parse(localStorage.getItem("azl_cart") || "[]"),
    categories: [],
    products: [],
    activeCategory: "all",
    fileNamesByKey: JSON.parse(localStorage.getItem("azl_files") || "{}")
  };

  function t(k){ return dict[state.lang][k]; }
  function money(x){ return `AED ${Number(x||0).toFixed(2)}`; }

  function save(){
    localStorage.setItem("azl_lang", state.lang);
    localStorage.setItem("azl_cart", JSON.stringify(state.cart));
    localStorage.setItem("azl_files", JSON.stringify(state.fileNamesByKey));
  }

  function showErr(msg){
    const el = $("#err");
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
  }

  async function loadProducts(){
    // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† products.json (Ø¨Ø¯ÙˆÙ† txt)
    const res = await fetch("/products.json", { cache:"no-store" });
    if(!res.ok) throw new Error("products.json not found (HTTP " + res.status + ")");
    const data = await res.json();
    state.categories = Array.isArray(data.categories) ? data.categories : [];
    state.products = Array.isArray(data.products) ? data.products : [];
  }

  function loadFallbackProducts(){
    state.categories = [
      { id:"print", ar:"Ø·Ø¨Ø§Ø¹Ø©", en:"Print" },
      { id:"gifts", ar:"Ù‡Ø¯Ø§ÙŠØ§", en:"Gifts" },
      { id:"frames", ar:"Ø¥Ø·Ø§Ø±Ø§Øª", en:"Frames" },
      { id:"magnet", ar:"Ù…ØºÙ†Ø§Ø·ÙŠØ³", en:"Magnet" }
    ];

    state.products = [
      { id:"p1", category:"print", name:{ar:"Ø·Ø¨Ø§Ø¹Ø© ØµÙˆØ±Ø©",en:"Photo Print"}, price:49 },
      { id:"p2", category:"gifts", name:{ar:"Ù‡Ø¯ÙŠØ© Ù…Ù…ÙŠØ²Ø©",en:"Special Gift"}, price:79 },
      { id:"p3", category:"frames", name:{ar:"Ø¥Ø·Ø§Ø± Ø­Ø§Ø¦Ø·",en:"Wall Frame"}, price:120 },
      {
        id:"m1",
        category:"magnet",
        name:{ ar:"ØµÙˆØ±Ø© Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠØ©", en:"Magnetic Photo" },
        variants:{
          sizes:[
            { key:"5x5", ar:"5Ã—5 Ø³Ù…", en:"5Ã—5 cm", base_price:39 },
            { key:"7x7", ar:"7Ã—7 Ø³Ù…", en:"7Ã—7 cm", base_price:49 }
          ],
          pieces:[4,6,8,12]
        },
        requires_uploads:true
      }
    ];
  }

  function applyLang(){
    document.documentElement.lang = state.lang;
    document.documentElement.dir  = state.lang==="ar" ? "rtl" : "ltr";

    $("#brand").textContent = t("brand");
    $("#hint").textContent = t("hint");
    $("#heroTitle").textContent = t("heroTitle");
    $("#heroSub").textContent = t("heroSub");
    $("#b1").textContent = t("b1");
    $("#b2").textContent = t("b2");
    $("#b3").textContent = t("b3");

    $("#cartTitle").textContent = t("cart");
    $("#totalLabel").textContent = t("total");
    $("#payBtn").textContent = t("pay");
    $("#codBtn").textContent = t("cod");
    $("#langBtn").textContent = state.lang==="ar" ? "EN" : "AR";
    $("#note").textContent = t("note");
  }

  function renderCategories(){
    const allBtn = `<button class="btn ghost active" data-cat="all">${t("all")}</button>`;
    const rest = state.categories.map(c=>`
      <button class="btn ghost" data-cat="${c.id}">${state.lang==="ar"?c.ar:c.en}</button>
    `).join("");

    $("#cats").innerHTML = allBtn + rest;

    $("#cats").querySelectorAll("button[data-cat]").forEach(b=>{
      b.addEventListener("click", ()=>{
        $("#cats").querySelectorAll("button").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        state.activeCategory = b.dataset.cat;
        renderProducts();
      });
    });
  }

  function productCardHTML(p){
    const name = (p.name?.[state.lang] || p.name?.en || "-");

    if(p.variants?.sizes?.length && Array.isArray(p.variants?.pieces)){
      const sizeOptions = p.variants.sizes.map(s=>`
        <option value="${s.key}">
          ${state.lang==="ar"?s.ar:s.en} â€” ${money(s.base_price)}
        </option>
      `).join("");

      const piecesOptions = p.variants.pieces.map(n=>`
        <option value="${n}">${t("pieces")}: ${n}</option>
      `).join("");

      return `
        <article class="card">
          <div class="img"></div>
          <div class="p">
            <b>${name}</b>

            <div>
              <label>${t("size")}</label>
              <select id="size_${p.id}">${sizeOptions}</select>
            </div>

            <div>
              <label>${t("pieces")}</label>
              <select id="pieces_${p.id}">${piecesOptions}</select>
            </div>

            <div class="divider"></div>

            <div>
              <label>${t("upload")}</label>
              <input type="file" id="files_${p.id}" multiple accept="image/*" />
              <div class="muted" id="filesHint_${p.id}"></div>
            </div>

            <div class="row" style="justify-content:space-between">
              <div class="price" id="price_${p.id}">${money(p.variants.sizes[0].base_price)}</div>
              <button class="btn ghost" data-add="${p.id}">${t("add")}</button>
            </div>
          </div>
        </article>
      `;
    }

    return `
      <article class="card">
        <div class="img"></div>
        <div class="p">
          <b>${name}</b>
          <div class="price">${money(p.price || 0)}</div>
          <button class="btn ghost" data-add="${p.id}">${t("add")}</button>
        </div>
      </article>
    `;
  }

  function renderProducts(){
    const list = (state.activeCategory==="all")
      ? state.products
      : state.products.filter(p => p.category === state.activeCategory);

    $("#grid").innerHTML = list.map(productCardHTML).join("");

    document.querySelectorAll("[data-add]").forEach(btn=>{
      btn.addEventListener("click", ()=> addToCart(btn.dataset.add));
    });

    list.forEach(p=>{
      if(p.variants?.sizes?.length){
        const sizeSel = document.getElementById(`size_${p.id}`);
        const piecesSel = document.getElementById(`pieces_${p.id}`);
        const filesInp = document.getElementById(`files_${p.id}`);
        const priceEl  = document.getElementById(`price_${p.id}`);
        const hintEl   = document.getElementById(`filesHint_${p.id}`);

        if(sizeSel && priceEl){
          sizeSel.addEventListener("change", ()=>{
            const s = p.variants.sizes.find(x=>x.key===sizeSel.value);
            priceEl.textContent = money(s?.base_price || 0);
          });
        }

        if(filesInp && piecesSel && hintEl){
          const updateHint = ()=>{
            const need = Number(piecesSel.value || 0);
            const got  = (filesInp.files?.length || 0);
            hintEl.textContent = `${t("files")}: ${got}/${need}`;
          };
          piecesSel.addEventListener("change", updateHint);
          filesInp.addEventListener("change", updateHint);
          updateHint();
        }
      }
    });

    updateCartUI();
  }

  function buildCartKey(p, sizeKey, pieces){
    return `${p.id}|${sizeKey||"-"}|${pieces||"-"}`;
  }

  function addToCart(id){
    const p = state.products.find(x=>x.id===id);
    if(!p) return;

    if(p.variants?.sizes?.length){
      const sizeKey = document.getElementById(`size_${id}`)?.value || p.variants.sizes[0].key;
      const pieces  = Number(document.getElementById(`pieces_${id}`)?.value || p.variants.pieces[0]);
      const sizeObj = p.variants.sizes.find(s=>s.key===sizeKey);
      const unitPrice = Number(sizeObj?.base_price || 0);

      const filesInp = document.getElementById(`files_${id}`);
      const files = filesInp ? Array.from(filesInp.files || []) : [];

      if(p.requires_uploads && files.length !== pieces){
        alert(t("needFiles"));
        return;
      }

      const key = buildCartKey(p, sizeKey, pieces);
      const it = state.cart.find(x=>x.key===key);
      if(it){ it.qty += 1; }
      else {
        state.cart.push({
          key,
          id:p.id,
          name:p.name,
          qty:1,
          unitPrice,
          size: (state.lang==="ar" ? (sizeObj?.ar || sizeKey) : (sizeObj?.en || sizeKey)),
          pieces,
          requires_uploads: !!p.requires_uploads
        });
      }

      if(p.requires_uploads){
        state.fileNamesByKey[key] = files.map(f=>f.name);
      }

      if(filesInp) filesInp.value = "";

      save(); updateCartUI(); openCart();
      return;
    }

    const key = buildCartKey(p, "-", "-");
    const it = state.cart.find(x=>x.key===key);
    if(it) it.qty += 1;
    else state.cart.push({ key, id:p.id, name:p.name, qty:1, unitPrice:Number(p.price||0) });

    save(); updateCartUI(); openCart();
  }

  function updateCartUI(){
    $("#count").textContent = state.cart.reduce((s,i)=> s + Number(i.qty||0), 0);
    const total = state.cart.reduce((s,i)=> s + (Number(i.unitPrice||0) * Number(i.qty||0)), 0);
    $("#total").textContent = money(total);

    const box = $("#items");
    if(!state.cart.length){
      box.innerHTML = `<div class="muted">${t("empty")}</div>`;
      $("#payBtn").disabled = true;
      return;
    }

    box.innerHTML = state.cart.map(i=>{
      const name = (i.name?.[state.lang] || i.name?.en || "Item");
      const meta = [];
      if(i.size) meta.push(`${t("size")}: ${i.size}`);
      if(i.pieces) meta.push(`${t("pieces")}: ${i.pieces}`);
      if(i.requires_uploads){
        const fn = state.fileNamesByKey[i.key] || [];
        meta.push(`${t("files")}: ${fn.length}/${i.pieces || 0}`);
      }

      return `
        <div class="cartItem" data-key="${i.key}">
          <div class="cartTop">
            <div>
              <div class="cartName">${name}</div>
              ${meta.length ? `<div class="cartMeta">${meta.join(" â€¢ ")}</div>` : ``}
            </div>
            <div style="text-align:end">
              <div style="font-weight:900">${money(Number(i.unitPrice||0) * Number(i.qty||0))}</div>
              <div class="muted">${money(Number(i.unitPrice||0))} Ã— ${Number(i.qty||0)}</div>
            </div>
          </div>

          <div class="cartControls">
            <div class="qtyBox">
              <button class="btn ghost small" data-dec="${i.key}">âˆ’</button>
              <input class="qtyInput" type="number" min="1" step="1" value="${Number(i.qty||0)}" data-setqty="${i.key}" />
              <button class="btn ghost small" data-inc="${i.key}">+</button>
            </div>

            <button class="btn ghost small danger" data-rm="${i.key}">${t("remove")}</button>
          </div>
        </div>
      `;
    }).join("");

    box.querySelectorAll("[data-inc]").forEach(b=>{
      b.addEventListener("click", ()=> changeQty(b.dataset.inc, +1));
    });
    box.querySelectorAll("[data-dec]").forEach(b=>{
      b.addEventListener("click", ()=> changeQty(b.dataset.dec, -1));
    });
    box.querySelectorAll("[data-rm]").forEach(b=>{
      b.addEventListener("click", ()=> removeItem(b.dataset.rm));
    });
    box.querySelectorAll("[data-setqty]").forEach(inp=>{
      inp.addEventListener("change", ()=>{
        const key = inp.dataset.setqty;
        const v = Math.max(1, Number(inp.value || 1));
        setQty(key, v);
      });
    });

    $("#payBtn").disabled = !canPayNow();
  }

  function changeQty(key, delta){
    const it = state.cart.find(x=>x.key===key);
    if(!it) return;
    it.qty = Number(it.qty||0) + delta;
    if(it.qty <= 0){ removeItem(key); return; }
    save(); updateCartUI();
  }

  function setQty(key, qty){
    const it = state.cart.find(x=>x.key===key);
    if(!it) return;
    it.qty = Math.max(1, Number(qty||1));
    save(); updateCartUI();
  }

  function removeItem(key){
    state.cart = state.cart.filter(x=>x.key !== key);
    delete state.fileNamesByKey[key];
    save(); updateCartUI();
  }

  function canPayNow(){
    for(const i of state.cart){
      if(i.requires_uploads){
        const fn = state.fileNamesByKey[i.key] || [];
        if(Number(fn.length) !== Number(i.pieces||0)) return false;
      }
    }
    return true;
  }

  function openCart(){ $("#drawer").classList.add("open"); }
  function closeCart(){ $("#drawer").classList.remove("open"); }

  async function payNow(){
    try{
      showErr("");
      if(!state.cart.length){ openCart(); return; }
      if(!canPayNow()){ alert(t("needFiles")); return; }

      const items = state.cart.map(i=>{
        const name = (i.name?.[state.lang] || i.name?.en || "Item");
        const opt = [];
        if(i.size) opt.push(`${t("size")}: ${i.size}`);
        if(i.pieces) opt.push(`${t("pieces")}: ${i.pieces}`);
        if(i.requires_uploads){
          const fn = state.fileNamesByKey[i.key] || [];
          opt.push(`${t("files")}: ${fn.length}/${i.pieces||0}`);
        }
        const finalName = opt.length ? `${name} â€” ${opt.join(" â€” ")}` : name;

        return { name: String(finalName), unit_amount: Number(i.unitPrice||0), quantity: Number(i.qty||1) };
      });

      const res = await fetch(`${WORKER_URL}/create-checkout-session`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ currency:"AED", lang: state.lang, items })
      });

      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch { data = { raw:text }; }

      if(!res.ok) throw new Error(data.error || data.raw || ("Worker error " + res.status));
      if(!data.url) throw new Error("No checkout URL returned");
      location.href = data.url;
    } catch(e){
      const msg = "Payment error: " + (e?.message || e);
      showErr(msg);
      alert(msg);
    }
  }

  function placeCOD(){
    const total = state.cart.reduce((s,i)=> s + (Number(i.unitPrice||0)*Number(i.qty||0)), 0);
    const lines = state.cart.map(i=>{
      const name = (i.name?.[state.lang] || i.name?.en || "-");
      const opt = [];
      if(i.size) opt.push(`${t("size")}: ${i.size}`);
      if(i.pieces) opt.push(`${t("pieces")}: ${i.pieces}`);
      if(i.requires_uploads){
        const fn = state.fileNamesByKey[i.key] || [];
        opt.push(`${t("files")}: ${fn.length}/${i.pieces||0}`);
      }
      const extras = opt.length ? ` (${opt.join(", ")})` : "";
      return `- ${name}${extras} x${i.qty} = ${money(Number(i.unitPrice||0)*Number(i.qty||0))}`;
    }).join("\n");

    const msg = state.lang==="ar"
      ? `Ø·Ù„Ø¨ COD Ù…Ù† Ù…ØªØ¬Ø± Ø£Ø²Ù„\n${lines}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${money(total)}`
      : `COD order from azl MG shop\n${lines}\nTotal: ${money(total)}`;

    window.open(`https://wa.me/${COD_WHATSAPP}?text=${encodeURIComponent(msg)}`,"_blank","noopener");
  }

  // ====== FIX Ø¥Ø¶Ø§ÙÙŠ: Ù…Ù†Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø· Ø¶ØºØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ù„Ø© ======
  $("#panel").addEventListener("click", (e)=> e.stopPropagation());
  $("#panel").addEventListener("pointerdown", (e)=> e.stopPropagation());

  // events
  $("#langBtn").addEventListener("click", ()=>{
    state.lang = state.lang==="ar" ? "en" : "ar";
    save();
    applyLang();
    renderCategories();
    renderProducts();
  });

  $("#cartBtn").addEventListener("click", openCart);
  $("#back").addEventListener("click", closeCart);
  $("#closeBtn").addEventListener("click", closeCart);
  $("#payBtn").addEventListener("click", payNow);
  $("#codBtn").addEventListener("click", placeCOD);

  // boot
  (async ()=>{
    try{ await loadProducts(); }
    catch(e){ loadFallbackProducts(); }

    applyLang();
    renderCategories();
    renderProducts();
    updateCartUI();
  })();
</script>
</body>
</html>
