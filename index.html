<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ØªØ¬Ø± Ø£Ø²Ù„ | azl MG shop</title>

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --line:#e6e8f0; --text:#0f172a; --muted:#64748b;
      --brand:#0b1220; --shadow:0 10px 30px rgba(15,23,42,.08); --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:50;background:rgba(246,247,251,.85);backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .bar{max-width:1100px;margin:0 auto;padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,#0b1220,#3b82f6);box-shadow:var(--shadow)}
    .sub{font-size:12px;color:var(--muted);margin-top:2px;font-weight:600}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 40px}

    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:800}
    .btn.ghost{background:#fff;color:var(--text);border:1px solid var(--line)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .hero{
      background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);
      padding:16px;display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap;
    }
    .hero h2{margin:0;font-size:18px}
    .hero p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .pill{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;font-weight:900;font-size:12px;cursor:pointer}
    .pill.active{background:var(--brand);border-color:var(--brand);color:#fff}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;
      display:flex;flex-direction:column;min-height:290px;
    }
    .img{height:140px;background:linear-gradient(135deg,#e8eefc,#ffffff)}
    .p{padding:12px;display:grid;gap:10px}
    .name{font-weight:950}
    .price{font-weight:950}
    .muted{color:var(--muted);font-size:12px}
    .small{font-size:11px;color:var(--muted);line-height:1.35}
    select,input[type="file"]{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff
    }
    .ok{color:#065f46;font-weight:900}
    .danger{color:#b91c1c;font-weight:900}

    /* drawer */
    .drawer{position:fixed;inset:0;pointer-events:none;z-index:9999}
    .drawer.open{pointer-events:auto}
    .back{position:absolute;inset:0;background:rgba(15,23,42,.38);opacity:0;transition:.2s}
    .drawer.open .back{opacity:1}
    .panel{
      position:absolute;top:0;bottom:0;inset-inline-end:0;width:min(420px,92vw);background:#fff;border-inline-start:1px solid var(--line);
      transform:translateX(110%);transition:.2s;display:flex;flex-direction:column
    }
    html[dir="ltr"] .panel{transform:translateX(-110%)}
    .drawer.open .panel{transform:translateX(0)}
    .head{padding:14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .body{padding:14px;overflow:auto;flex:1}
    .foot{padding:14px;border-top:1px solid var(--line)}
    .item{border:1px solid var(--line);border-radius:14px;padding:10px;margin-bottom:10px;display:grid;gap:6px}
    .split{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .xbtn{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:900}
    .xbtn:active{transform:translateY(1px)}
  </style>
</head>

<body>
<header>
  <div class="bar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div id="brandTxt">Ù…ØªØ¬Ø± Ø£Ø²Ù„</div>
        <div class="sub" id="subTxt">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
      </div>
    </div>

    <div class="row">
      <button class="btn ghost" id="langBtn">EN</button>
      <button class="btn ghost" id="cartBtn">ğŸ›’ <span id="count">0</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <div style="min-width:min(520px,100%)">
      <h2 id="heroTitle">ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ù†Ø¸ÙŠÙØ© ÙˆØ³Ø±ÙŠØ¹Ø©</h2>
      <p id="heroDesc">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…ØŒ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ Ø§Ø¯ÙØ¹ Ø¹Ø¨Ø± Stripe Ø£Ùˆ Ø§Ø·Ù„Ø¨ COD Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.</p>
      <div class="pills" id="cats"></div>
    </div>
    <div class="small" id="noteTop"></div>
  </section>

  <section class="grid" id="grid"></section>
</main>

<aside class="drawer" id="drawer" aria-hidden="true">
  <div class="panel">
    <div class="head">
      <b id="cartTitle">Ø³Ù„ØªÙƒ</b>
      <button class="btn ghost" id="closeBtn">âœ•</button>
    </div>

    <div class="body">
      <div id="items"></div>
    </div>

    <div class="foot">
      <div class="split">
        <span id="totalLabel">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
        <b id="total">AED 0.00</b>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="payBtn">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
        <button class="btn ghost" id="codBtn">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)</button>
      </div>

      <div class="small" id="note" style="margin-top:10px"></div>
      <div class="small danger" id="err" style="margin-top:8px;display:none"></div>
    </div>
  </div>
  <div class="back" id="back"></div>
</aside>

<script>
  // ====== CONFIG ======
  const WORKER_URL   = "https://azlshop.eng-suwan.workers.dev";
  const COD_WHATSAPP = "971544219984";

  // ====== I18N ======
  const dict = {
    ar: {
      brand:"Ù…ØªØ¬Ø± Ø£Ø²Ù„", latest:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
      heroTitle:"ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ù†Ø¸ÙŠÙØ© ÙˆØ³Ø±ÙŠØ¹Ø©",
      heroDesc:"Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…ØŒ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ Ø§Ø¯ÙØ¹ Ø¹Ø¨Ø± Stripe Ø£Ùˆ Ø§Ø·Ù„Ø¨ COD Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.",
      cart:"Ø³Ù„ØªÙƒ", total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", pay:"Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†", cod:"Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)",
      add:"Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©", all:"Ø§Ù„ÙƒÙ„",
      empty:"Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.",
      size:"Ø§Ù„Ù…Ù‚Ø§Ø³", pieces:"Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹",
      upload:"Ø§Ø±ÙØ¹ ØµÙˆØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©",
      uploadRule:"Ù„Ø§Ø²Ù… ØªØ±ÙØ¹ ØµÙˆØ± Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©.",
      filesOk:"Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± ØµØ­ÙŠØ­",
      filesBad:"Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚",
      note:"Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØªØªØ·Ù„Ø¨ Ø±ÙØ¹ ØµÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.",
      loading:"Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦",
      remove:"Ø­Ø°Ù",
      need:"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ ÙˆØ±ÙØ¹ Ø§Ù„ØµÙˆØ±."
    },
    en: {
      brand:"azl MG shop", latest:"Latest products",
      heroTitle:"Clean & fast shopping experience",
      heroDesc:"Pick a category, add to cart, pay via Stripe or order COD on WhatsApp.",
      cart:"Your cart", total:"Total", pay:"Pay now", cod:"Cash on Delivery (COD)",
      add:"Add to cart", all:"All",
      empty:"Your cart is empty.",
      size:"Size", pieces:"Pieces",
      upload:"Upload print files",
      uploadRule:"You must upload files equal to selected pieces before adding to cart.",
      filesOk:"File count OK",
      filesBad:"File count mismatch",
      note:"Note: Print products require uploading files before adding to cart.",
      loading:"Loadingâ€¦",
      remove:"Remove",
      need:"Please select size, pieces, and upload files."
    }
  };

  const $ = (s)=>document.querySelector(s);

  function detectLang(){
    const l = (navigator.language || "en").toLowerCase();
    return l.startsWith("ar") ? "ar" : "en";
  }

  const state = {
    lang: localStorage.getItem("azl_lang") || detectLang(),
    cart: JSON.parse(localStorage.getItem("azl_cart") || "[]"),
    categories: [],
    products: [],
    activeCategory: "all"
  };

  function t(k){ return dict[state.lang][k]; }
  function money(x){ return `AED ${Number(x).toFixed(2)}`; }
  function save(){
    localStorage.setItem("azl_cart", JSON.stringify(state.cart));
    localStorage.setItem("azl_lang", state.lang);
  }
  function setErr(msg){
    const el = $("#err");
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
  }

  // âœ… Fix NaN + old carts
  (function migrateCart(){
    const cart = Array.isArray(state.cart) ? state.cart : [];
    state.cart = cart.map(it=>{
      const qty = Number(it.qty ?? 1);
      const priceRaw = it.unitPrice ?? it.price ?? it.unit_amount ?? 0;
      const unitPrice = Number(priceRaw);
      return {
        ...it,
        qty: (Number.isFinite(qty) && qty>0) ? qty : 1,
        unitPrice: Number.isFinite(unitPrice) ? unitPrice : 0,
        files: Array.isArray(it.files) ? it.files : []
      };
    }).filter(it => it && it.key);
    save();
  })();

  // ====== LOAD PRODUCTS (try products.json then products.json.txt) ======
  async function fetchJsonSmart(){
    const tries = ["/products.json", "/products.json.txt"];
    let lastErr = null;
    for(const path of tries){
      try{
        const res = await fetch(path, { cache:"no-store" });
        if(!res.ok) { lastErr = new Error(path + " HTTP " + res.status); continue; }
        // read as text first to avoid "Unexpected token <"
        const text = await res.text();
        const data = JSON.parse(text);
        return data;
      } catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("Cannot load products file");
  }

  async function loadProducts(){
    const data = await fetchJsonSmart();
    state.categories = Array.isArray(data.categories) ? data.categories : [];
    state.products   = Array.isArray(data.products) ? data.products : [];
  }

  // ====== UI ======
  function applyLang(){
    document.documentElement.lang = state.lang;
    document.documentElement.dir  = state.lang==="ar" ? "rtl" : "ltr";

    $("#brandTxt").textContent = t("brand");
    $("#subTxt").textContent   = t("latest");
    $("#heroTitle").textContent = t("heroTitle");
    $("#heroDesc").textContent  = t("heroDesc");
    $("#cartTitle").textContent = t("cart");
    $("#totalLabel").textContent = t("total");
    $("#payBtn").textContent = t("pay");
    $("#codBtn").textContent = t("cod");
    $("#langBtn").textContent = state.lang==="ar" ? "EN" : "AR";
    $("#note").textContent = t("note");
    $("#noteTop").textContent = t("note");
  }

  function renderCategories(){
    const pills = [
      `<button class="pill ${state.activeCategory==="all"?"active":""}" data-cat="all">${t("all")}</button>`,
      ...state.categories.map(c =>
        `<button class="pill ${state.activeCategory===c.id?"active":""}" data-cat="${c.id}">${state.lang==="ar"?c.ar:c.en}</button>`
      )
    ];
    $("#cats").innerHTML = pills.join("");
    $("#cats").querySelectorAll("[data-cat]").forEach(b=>{
      b.addEventListener("click", ()=>{
        state.activeCategory = b.dataset.cat;
        renderCategories();
        renderProducts();
      });
    });
  }

  function getDynamicPriceForPrintUpload(p, sizeId, pieces){
    const sizeObj = (p.sizes||[]).find(s=>s.id===sizeId);
    if(!sizeObj) return 0;
    // prices: {"4":39,"6":49,...}
    const v = sizeObj.prices ? sizeObj.prices[String(pieces)] : 0;
    return Number(v || 0);
  }

  function productCard(p){
    const name = (p.name?.[state.lang] || p.name?.en || "-");

    if(p.type === "simple"){
      const price = Number(p.price||0);
      return `
        <article class="card">
          <div class="img"></div>
          <div class="p">
            <div class="name">${name}</div>
            <div class="price">${money(price)}</div>
            <button class="btn" data-add="${p.id}">${t("add")}</button>
            <div class="muted">${p.category}</div>
          </div>
        </article>
      `;
    }

    if(p.type === "print_upload"){
      const sizes = (p.sizes||[]).map(s=>{
        const label = state.lang==="ar" ? s.label_ar : s.label_en;
        return `<option value="${s.id}">${label}</option>`;
      }).join("");

      const pieces = (p.pieces||[]).map(n=>`<option value="${n}">${t("pieces")}: ${n}</option>`).join("");

      return `
        <article class="card">
          <div class="img"></div>
          <div class="p">
            <div class="name">${name}</div>

            <div class="row">
              <select id="size_${p.id}">${sizes}</select>
            </div>

            <div class="row">
              <select id="pieces_${p.id}">${pieces}</select>
            </div>

            <div class="row">
              <input id="files_${p.id}" type="file" multiple accept="image/*" />
            </div>

            <div class="small" id="priceHint_${p.id}"></div>
            <div class="small" id="filesHint_${p.id}">${t("uploadRule")}</div>

            <button class="btn" data-add="${p.id}">${t("add")}</button>
            <div class="muted">${p.category}</div>
          </div>
        </article>
      `;
    }

    return `
      <article class="card">
        <div class="img"></div>
        <div class="p">
          <div class="name">${name}</div>
          <div class="muted">Unsupported product type</div>
        </div>
      </article>
    `;
  }

  function renderProducts(){
    const list = state.activeCategory==="all"
      ? state.products
      : state.products.filter(p => p.category === state.activeCategory);

    $("#grid").innerHTML = list.map(productCard).join("");

    document.querySelectorAll("[data-add]").forEach(btn=>{
      btn.addEventListener("click", ()=> addToCart(btn.dataset.add));
    });

    // live validation for print_upload + dynamic price display
    list.filter(p=>p.type==="print_upload").forEach(p=>{
      const sizeEl   = document.getElementById(`size_${p.id}`);
      const piecesEl = document.getElementById(`pieces_${p.id}`);
      const filesEl  = document.getElementById(`files_${p.id}`);
      const hintEl   = document.getElementById(`filesHint_${p.id}`);
      const priceEl  = document.getElementById(`priceHint_${p.id}`);

      function updatePrice(){
        const sizeId = String(sizeEl.value);
        const pieces = Number(piecesEl.value);
        const price = getDynamicPriceForPrintUpload(p, sizeId, pieces);
        const sizeObj = (p.sizes||[]).find(s=>s.id===sizeId);
        const sizeLabel = state.lang==="ar" ? sizeObj?.label_ar : sizeObj?.label_en;
        priceEl.className = "small";
        priceEl.textContent = `${t("size")}: ${sizeLabel || sizeId} â€¢ ${t("pieces")}: ${pieces} â€¢ ${money(price)}`;
      }

      function validateFiles(){
        const pieces = Number(piecesEl.value);
        const count  = filesEl.files ? filesEl.files.length : 0;
        if(count === 0){
          hintEl.className = "small";
          hintEl.textContent = t("uploadRule");
          return;
        }
        if(count === pieces){
          hintEl.className = "small ok";
          hintEl.textContent = t("filesOk");
        } else {
          hintEl.className = "small danger";
          hintEl.textContent = t("filesBad") + ` (${count}/${pieces})`;
        }
      }

      sizeEl.addEventListener("change", ()=>{ updatePrice(); validateFiles(); });
      piecesEl.addEventListener("change", ()=>{ updatePrice(); validateFiles(); });
      filesEl.addEventListener("change", validateFiles);

      updatePrice();
      validateFiles();
    });

    updateCartUI();
  }

  // ====== CART ======
  function openCart(){ $("#drawer").classList.add("open"); }
  function closeCart(){ $("#drawer").classList.remove("open"); }

  function updateCartUI(){
    $("#count").textContent = state.cart.reduce((s,i)=>s+i.qty,0);
    const total = state.cart.reduce((s,i)=> s + (Number(i.unitPrice||0) * i.qty), 0);
    $("#total").textContent = money(total);

    const box = $("#items");
    if(!state.cart.length){
      box.innerHTML = `<div class="muted">${t("empty")}</div>`;
      return;
    }

    box.innerHTML = state.cart.map(i=>{
      const n = (i.name?.[state.lang] || i.name?.en || "-");
      const opt = i.options
        ? ` â€¢ ${t("size")}: ${i.options.sizeLabel} â€¢ ${t("pieces")}: ${i.options.pieces} â€¢ Files: ${(i.files?.length||0)}/${i.options.pieces}`
        : "";
      return `
        <div class="item">
          <div class="split">
            <b>${n}${opt}</b>
            <button class="xbtn" data-rm="${i.key}">${t("remove")}</button>
          </div>
          <div class="split">
            <span class="muted">${money(i.unitPrice)} Ã— ${i.qty}</span>
            <b>${money(Number(i.unitPrice)*i.qty)}</b>
          </div>
        </div>
      `;
    }).join("");

    document.querySelectorAll("[data-rm]").forEach(b=>{
      b.addEventListener("click", ()=>{
        state.cart = state.cart.filter(x=>x.key !== b.dataset.rm);
        save();
        updateCartUI();
      });
    });
  }

  async function uploadFilesToWorker(files){
    const fd = new FormData();
    for(const f of files) fd.append("files", f, f.name);
    const res = await fetch(`${WORKER_URL}/upload`, { method:"POST", body: fd });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || ("Upload failed: HTTP " + res.status));
    if(!Array.isArray(data.keys)) throw new Error("Upload response missing keys");
    return data.keys;
  }

  async function addToCart(productId){
    try{
      setErr("");
      const p = state.products.find(x=>x.id===productId);
      if(!p) return;

      if(p.type === "simple"){
        const unitPrice = Number(p.price||0);
        const key = `${p.id}|simple`;
        const it = state.cart.find(x=>x.key===key);
        if(it) it.qty++;
        else state.cart.push({ key, id:p.id, name:p.name, qty:1, unitPrice, options:null, files:[] });
        save(); updateCartUI(); openCart();
        return;
      }

      if(p.type === "print_upload"){
        const sizeEl   = document.getElementById(`size_${p.id}`);
        const piecesEl = document.getElementById(`pieces_${p.id}`);
        const filesEl  = document.getElementById(`files_${p.id}`);

        const sizeId = String(sizeEl.value || "");
        const pieces = Number(piecesEl.value || 0);
        const files  = filesEl.files ? Array.from(filesEl.files) : [];

        if(!sizeId || !pieces) throw new Error(t("need"));
        if(files.length !== pieces){
          throw new Error(state.lang==="ar"
            ? `ÙŠØ¬Ø¨ Ø±ÙØ¹ ${pieces} ØµÙˆØ± (Ø§Ù„Ø¢Ù†: ${files.length}).`
            : `You must upload ${pieces} files (now: ${files.length}).`
          );
        }

        // Validate accepted types if provided
        const accepted = Array.isArray(p.rules?.accepted_types) ? p.rules.accepted_types : [];
        if(accepted.length){
          for(const f of files){
            if(!accepted.includes(f.type)){
              throw new Error((state.lang==="ar" ? "Ù†ÙˆØ¹ Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…: " : "Unsupported file type: ") + f.type);
            }
          }
        }

        // Upload now
        const keys = await uploadFilesToWorker(files);

        const sizeObj = (p.sizes||[]).find(s=>s.id===sizeId);
        const sizeLabel = state.lang==="ar" ? sizeObj?.label_ar : sizeObj?.label_en;

        const unitPrice = getDynamicPriceForPrintUpload(p, sizeId, pieces);

        const key = `${p.id}|${sizeId}|${pieces}|${keys.join(",")}`;
        state.cart.push({
          key,
          id: p.id,
          name: p.name,
          qty: 1,
          unitPrice,
          options: { sizeId, sizeLabel, pieces },
          files: keys
        });

        // reset input
        filesEl.value = "";
        save(); updateCartUI(); openCart();
        return;
      }

    } catch(e){
      setErr(e?.message || String(e));
      openCart();
    }
  }

  // ====== PAYMENTS ======
  async function payNow(){
    try{
      setErr("");
      if(!state.cart.length){ openCart(); return; }

      // Ensure all print items have files
      for(const it of state.cart){
        if(it.options?.pieces && (!it.files || it.files.length !== it.options.pieces)){
          throw new Error(state.lang==="ar"
            ? "ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬ Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø¯ÙˆÙ† ØµÙˆØ± ÙƒØ§ÙÙŠØ©."
            : "A print item is missing required files."
          );
        }
      }

      const items = state.cart.map(i=>{
        const baseName = (i.name?.[state.lang] || i.name?.en || "Item");
        const opt = i.options ? ` â€” ${t("size")}: ${i.options.sizeLabel} â€” ${t("pieces")}: ${i.options.pieces}` : "";
        return {
          name: String(baseName + opt),
          unit_amount: Number(i.unitPrice),
          quantity: Number(i.qty),
          files: i.files || []
        };
      });

      const res = await fetch(`${WORKER_URL}/create-checkout-session`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ currency:"AED", lang: state.lang, items })
      });

      const data = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(data.error || ("Worker error " + res.status));
      if(!data.url) throw new Error("No checkout URL returned");
      location.href = data.url;

    } catch(e){
      setErr(e?.message || String(e));
      openCart();
    }
  }

  function placeCOD(){
    if(!state.cart.length){ openCart(); return; }

    const lines = state.cart.map(i=>{
      const n = (i.name?.[state.lang] || i.name?.en || "-");
      const opt = i.options ? ` (${i.options.sizeLabel}, ${t("pieces")}: ${i.options.pieces}, files:${(i.files?.length||0)})` : "";
      return `- ${n}${opt} x${i.qty} = ${money(Number(i.unitPrice)*i.qty)}`;
    }).join("\n");

    const total = state.cart.reduce((s,i)=> s + Number(i.unitPrice)*i.qty, 0);
    const msg = state.lang==="ar"
      ? `Ø·Ù„Ø¨ COD Ù…Ù† Ù…ØªØ¬Ø± Ø£Ø²Ù„\n${lines}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${money(total)}`
      : `COD order from azl MG shop\n${lines}\nTotal: ${money(total)}`;

    window.open(`https://wa.me/${COD_WHATSAPP}?text=${encodeURIComponent(msg)}`,"_blank","noopener");
  }

  // ====== EVENTS ======
  $("#langBtn").addEventListener("click", ()=>{
    state.lang = state.lang==="ar" ? "en" : "ar";
    save();
    applyLang();
    renderCategories();
    renderProducts();
  });
  $("#cartBtn").addEventListener("click", openCart);
  $("#back").addEventListener("click", closeCart);
  $("#closeBtn").addEventListener("click", closeCart);
  $("#payBtn").addEventListener("click", payNow);
  $("#codBtn").addEventListener("click", placeCOD);

  // ====== BOOT ======
  (async ()=>{
    try{
      $("#grid").innerHTML = `<div class="muted">${t("loading")}</div>`;
      await loadProducts();
      applyLang();
      renderCategories();
      renderProducts();
    } catch(e){
      applyLang();
      setErr("Load error: " + (e?.message || e));
      $("#grid").innerHTML = `<div class="muted">Load error: ${(e?.message||e)}</div>`;
      openCart();
    }
  })();
</script>
</body>
</html>
