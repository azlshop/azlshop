<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ØªØ¬Ø± Ø£Ø²Ù„ | azl MG shop</title>

  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --line:#e6e8ef;
      --text:#0f172a;
      --muted:#6b7280;
      --dark:#0b1220;
      --shadow: 0 10px 30px rgba(2,8,23,.06);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    a{color:inherit}

    header{
      position:sticky;top:0;z-index:50;
      background:rgba(255,255,255,.9);
      backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1150px;margin:0 auto;padding:14px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:900;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;background:var(--dark);
      box-shadow:var(--shadow);
    }
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);background:#fff;color:var(--text);
      border-radius:999px;padding:10px 14px;cursor:pointer;
      box-shadow: 0 6px 18px rgba(2,8,23,.05);
    }
    .pill.dark{background:var(--dark);color:#fff;border-color:var(--dark)}
    .pill:active{transform:translateY(1px)}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}

    .hero{
      margin-top:14px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .hero h3{margin:0;font-size:18px}
    .hero p{margin:4px 0 0 0;color:var(--muted);font-size:13px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--line);background:#fff;
      padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#22c55e}
    .dot.gray{background:#a3a3a3}
    .dot.purple{background:#a855f7}

    .cats{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    .catBtn{
      border:1px solid var(--line);
      background:#fff;color:var(--text);
      border-radius:999px;padding:10px 12px;cursor:pointer;
    }
    .catBtn.active{background:var(--dark);border-color:var(--dark);color:#fff}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow:var(--shadow);
      display:flex;flex-direction:column;
      min-height:310px;
    }
    .img{height:140px;background:linear-gradient(135deg,#f1f5f9,#ffffff)}
    .p{padding:12px;display:grid;gap:10px}
    .name{font-weight:800}
    .price{font-weight:900}
    .sub{color:var(--muted);font-size:12px}
    select,input[type="number"],input[type="text"]{
      width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;
      outline:none;
    }
    input[type="file"]{
      width:100%;
      padding:10px 12px;border-radius:14px;border:1px dashed #cbd5e1;background:#fff;
    }
    .addBtn{
      margin-top:auto;
      width:100%;
      border:1px solid var(--dark);
      background:var(--dark);
      color:#fff;border-radius:999px;padding:12px 14px;cursor:pointer;
    }
    .addBtn.ghost{background:#fff;color:var(--text);border-color:var(--line)}
    .addBtn:active{transform:translateY(1px)}

    /* Drawer / Cart */
    .drawer{position:fixed;inset:0;z-index:9999;display:none}
    .drawer.open{display:block}
    .back{
      position:absolute;inset:0;background:rgba(15,23,42,.45);
      pointer-events:auto; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ */
    }
    .panel{
      position:absolute;top:0;bottom:0;inset-inline-end:0;
      width:min(460px,92vw);
      background:#fff;border-inline-start:1px solid var(--line);
      box-shadow: -20px 0 40px rgba(2,8,23,.08);
      display:flex;flex-direction:column;
      pointer-events:auto;
    }
    html[dir="ltr"] .panel{inset-inline-end:auto;inset-inline-start:0;border-inline-start:none;border-inline-end:1px solid var(--line)}
    .panelHead{
      padding:14px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panelTitle{font-weight:900}
    .iconBtn{
      width:38px;height:38px;border-radius:999px;border:1px solid var(--line);
      background:#fff;cursor:pointer;
    }
    .panelBody{padding:14px;overflow:auto;flex:1}
    .panelFoot{
      padding:14px;border-top:1px solid var(--line);
      display:grid;gap:10px;background:#fff;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .total{font-weight:900}
    .payRow{display:flex;gap:10px;flex-wrap:wrap}
    .warn{color:#b45309;font-size:12px}
    .err{color:#b91c1c;font-size:12px}

    .cartItem{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:grid;gap:8px;
      margin-bottom:10px;
    }
    .ciTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .ciName{font-weight:800}
    .ciMeta{color:var(--muted);font-size:12px}
    .ciPrice{font-weight:900;white-space:nowrap}
    .qtyRow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .miniBtn{
      width:34px;height:34px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;
    }
    .qtyInput{
      width:86px;text-align:center;border-radius:999px;
    }
    .delBtn{
      border:1px solid #fecaca;background:#fff;color:#dc2626;border-radius:999px;padding:8px 10px;cursor:pointer;
      font-weight:700;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div id="brandText">Ù…ØªØ¬Ø± Ø£Ø²Ù„</div>
          <div class="hint" id="hint">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
        </div>
      </div>

      <div class="actions">
        <button class="pill" id="langBtn">EN</button>
        <button class="pill" id="cartBtn">ğŸ›’ <span id="count">0</span></button>
      </div>
    </div>

    <div class="hero">
      <div>
        <h3 id="heroTitle">ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø³Ø±ÙŠØ¹Ø© ÙˆÙ…Ø±ØªØ¨Ø©</h3>
        <p id="heroSub">Ø§Ø®ØªØ± Ù‚Ø³Ù…ØŒ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ Ø«Ù… Ø§Ø¯ÙØ¹ Ø¹Ø¨Ø± Stripe Ø£Ùˆ Ø§Ø·Ù„Ø¨ COD Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.</p>
        <div class="chips" style="margin-top:10px">
          <span class="chip"><span class="dot"></span><span id="c1">Ø¯ÙØ¹ Ø¢Ù…Ù†</span></span>
          <span class="chip"><span class="dot purple"></span><span id="c2">COD Ù…ØªØ§Ø­</span></span>
          <span class="chip"><span class="dot gray"></span><span id="c3">Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span></span>
        </div>
      </div>
      <div class="cats" id="cats"></div>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:14px">
  <section class="grid" id="grid"></section>
</main>

<!-- Cart Drawer -->
<aside class="drawer" id="drawer" aria-hidden="true">
  <div class="back" id="back"></div>

  <div class="panel" role="dialog" aria-modal="true" aria-label="Cart">
    <div class="panelHead">
      <div class="panelTitle" id="cartTitle">Ø³Ù„ØªÙƒ</div>
      <button class="iconBtn" id="closeBtn" aria-label="Close">âœ•</button>
    </div>

    <div class="panelBody">
      <div id="items"></div>
      <div class="err" id="cartErr" style="display:none"></div>
    </div>

    <div class="panelFoot">
      <div class="row">
        <span id="totalLabel">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
        <span class="total" id="total">AED 0.00</span>
      </div>

      <div class="payRow">
        <button class="pill dark" id="payBtn" style="flex:1">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
        <button class="pill" id="codBtn" style="flex:1">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)</button>
      </div>

      <div class="warn" id="note">
        Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØªØ·Ù„Ø¨ ØµÙˆØ± (Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³): ØªØ£ÙƒØ¯ Ø£Ù† Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± ÙŠØ³Ø§ÙˆÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹.
      </div>
    </div>
  </div>
</aside>

<script>
  // âœ… Stripe Worker Endpoint (server-side creates Checkout Session then returns url)
  const WORKER_URL = "https://azlshop.eng-suwan.workers.dev";
  const COD_WHATSAPP = "971544219984";

  const dict = {
    ar: {
      brand:"Ù…ØªØ¬Ø± Ø£Ø²Ù„",
      hint:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
      heroTitle:"ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø³Ø±ÙŠØ¹Ø© ÙˆÙ…Ø±ØªØ¨Ø©",
      heroSub:"Ø§Ø®ØªØ± Ù‚Ø³Ù…ØŒ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ Ø«Ù… Ø§Ø¯ÙØ¹ Ø¹Ø¨Ø± Stripe Ø£Ùˆ Ø§Ø·Ù„Ø¨ COD Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.",
      c1:"Ø¯ÙØ¹ Ø¢Ù…Ù†", c2:"COD Ù…ØªØ§Ø­", c3:"Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ",
      all:"Ø§Ù„ÙƒÙ„",
      cart:"Ø³Ù„ØªÙƒ",
      total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
      pay:"Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†",
      cod:"Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)",
      add:"Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©",
      empty:"Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©",
      size:"Ø§Ù„Ø­Ø¬Ù…",
      pieces:"Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹",
      upload:"Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©",
      filesNeed:"Ù„Ø§Ø²Ù… ØªØ±ÙØ¹ ØµÙˆØ± Ø¨Ø¹Ø¯Ø¯ ÙŠØ³Ø§ÙˆÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹.",
      remove:"Ø­Ø°Ù",
      qty:"Ø§Ù„ÙƒÙ…ÙŠØ©",
      loadErr:"Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: "
    },
    en: {
      brand:"azl MG shop",
      hint:"Latest products",
      heroTitle:"Clean & fast shopping experience",
      heroSub:"Pick a category, add to cart, then pay via Stripe or place COD via WhatsApp.",
      c1:"Secure payments", c2:"COD available", c3:"Auto Arabic/English",
      all:"All",
      cart:"Your cart",
      total:"Total",
      pay:"Pay now",
      cod:"Cash on Delivery (COD)",
      add:"Add to cart",
      empty:"Your cart is empty",
      size:"Size",
      pieces:"Pieces",
      upload:"Upload print photos",
      filesNeed:"You must upload the same number of photos as pieces.",
      remove:"Remove",
      qty:"Qty",
      loadErr:"Load error: "
    }
  };

  const $ = (s)=>document.querySelector(s);
  const money = (x)=> `AED ${Number(x||0).toFixed(2)}`;

  const state = {
    lang: localStorage.getItem("azl_lang") || (((navigator.language||"en").toLowerCase().startsWith("ar")) ? "ar" : "en"),
    products: [],
    categories: [],
    activeCategory: "all",
    cart: JSON.parse(localStorage.getItem("azl_cart") || "[]"),
  };

  function t(k){ return dict[state.lang][k]; }
  function save(){
    localStorage.setItem("azl_lang", state.lang);
    localStorage.setItem("azl_cart", JSON.stringify(state.cart));
  }

  function applyLang(){
    document.documentElement.lang = state.lang;
    document.documentElement.dir  = state.lang==="ar" ? "rtl" : "ltr";

    $("#brandText").textContent = t("brand");
    $("#hint").textContent = t("hint");
    $("#heroTitle").textContent = t("heroTitle");
    $("#heroSub").textContent = t("heroSub");
    $("#c1").textContent = t("c1");
    $("#c2").textContent = t("c2");
    $("#c3").textContent = t("c3");

    $("#cartTitle").textContent = t("cart");
    $("#totalLabel").textContent = t("total");
    $("#payBtn").textContent = t("pay");
    $("#codBtn").textContent = t("cod");

    $("#langBtn").textContent = (state.lang==="ar") ? "EN" : "AR";
  }

  async function loadProducts(){
    // Ù…Ù‡Ù…: Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù products.json (Ø¨Ø¯ÙˆÙ† .txt)
    const res = await fetch("/products.json", { cache:"no-store" });
    if(!res.ok) throw new Error("products.json not found (HTTP " + res.status + ")");
    const data = await res.json();
    state.categories = Array.isArray(data.categories) ? data.categories : [];
    state.products = Array.isArray(data.products) ? data.products : [];
  }

  function renderCategories(){
    const cats = [
      { id:"all", ar:t("all"), en:t("all") },
      ...state.categories
    ];

    $("#cats").innerHTML = cats.map(c=>{
      const label = state.lang==="ar" ? (c.ar||c.en||c.id) : (c.en||c.ar||c.id);
      const active = (state.activeCategory===c.id) ? "active" : "";
      return `<button class="catBtn ${active}" data-cat="${c.id}">${label}</button>`;
    }).join("");

    $("#cats").querySelectorAll("[data-cat]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.activeCategory = btn.dataset.cat;
        renderCategories();
        renderProducts();
      });
    });
  }

  function productCard(p){
    const name = p.name?.[state.lang] || p.name?.en || p.id;
    const cat = p.category || "";
    const hasVariants = Array.isArray(p.variants) && p.variants.length;

    // UI ids
    const sizeId = `size_${p.id}`;
    const piecesId = `pieces_${p.id}`;
    const filesId = `files_${p.id}`;

    const variantUI = hasVariants ? `
      <div class="sub">${t("size")}</div>
      <select id="${sizeId}">
        ${p.variants.map(v=>{
          const label = state.lang==="ar" ? (v.ar||v.en||v.id) : (v.en||v.ar||v.id);
          return `<option value="${v.id}">${label}</option>`;
        }).join("")}
      </select>

      <div class="sub">${t("pieces")}</div>
      <select id="${piecesId}">
        ${(p.pieces||[]).map(n=> `<option value="${n}">${t("pieces")}: ${n}</option>`).join("")}
      </select>

      ${p.requiresFiles ? `
        <div class="sub">${t("upload")}</div>
        <input id="${filesId}" type="file" multiple accept="image/*" />
        <div class="sub" id="${filesId}_hint" style="color:var(--muted)"></div>
      ` : ``}
    ` : `
      <div class="price">${money(Number(p.price||0))}</div>
      <div class="sub">${cat}</div>
    `;

    return `
      <article class="card">
        <div class="img"></div>
        <div class="p">
          <div class="name">${name}</div>
          ${hasVariants ? `<div class="price" id="price_${p.id}">${money(0)}</div><div class="sub">${cat}</div>` : ``}
          ${variantUI}
          <button class="addBtn" data-add="${p.id}">${t("add")}</button>
        </div>
      </article>
    `;
  }

  function getVariantPrice(p, variantId, pieces){
    // pricing matrix: p.pricing[variantId][pieces] => number
    const v = String(variantId||"");
    const pc = String(pieces||"");
    const price = p?.pricing?.[v]?.[pc];
    return Number(price || 0);
  }

  function renderProducts(){
    const list = (state.activeCategory==="all")
      ? state.products
      : state.products.filter(p => p.category === state.activeCategory);

    $("#grid").innerHTML = list.map(productCard).join("");

    // Wire add buttons + dynamic price updates for variants
    list.forEach(p=>{
      const addBtn = document.querySelector(`[data-add="${p.id}"]`);
      if(addBtn) addBtn.addEventListener("click", ()=> addToCart(p.id));

      if(Array.isArray(p.variants) && p.variants.length){
        const sizeEl = document.getElementById(`size_${p.id}`);
        const piecesEl = document.getElementById(`pieces_${p.id}`);
        const priceEl = document.getElementById(`price_${p.id}`);
        const hintEl = document.getElementById(`files_${p.id}_hint`);
        const filesEl = document.getElementById(`files_${p.id}`);

        const refresh = ()=>{
          const v = sizeEl?.value || p.variants[0].id;
          const pc = Number(piecesEl?.value || (p.pieces?.[0]||1));
          const pr = getVariantPrice(p, v, pc);
          if(priceEl) priceEl.textContent = money(pr);
          if(hintEl) hintEl.textContent = (state.lang==="ar")
            ? `Ù„Ø§Ø²Ù… ØªØ±ÙØ¹ ${pc} ØµÙˆØ±`
            : `Upload ${pc} photos`;
          // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± piecesØŒ Ù…Ù† Ø§Ù„Ø£ÙØ¶Ù„ ØªØµÙÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª Ù„ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø±ÙØ¹ Ø§Ù„ØµØ­ÙŠØ­
          if(filesEl) filesEl.value = "";
        };

        if(sizeEl) sizeEl.addEventListener("change", refresh);
        if(piecesEl) piecesEl.addEventListener("change", refresh);
        refresh();
      }
    });

    updateCartUI();
  }

  function cartKey(pId, variantId, pieces, filesCount){
    return `${pId}|${variantId||"-"}|${pieces||"-"}|${filesCount||0}`;
  }

  function addToCart(productId){
    const p = state.products.find(x=>x.id===productId);
    if(!p) return;

    const hasVariants = Array.isArray(p.variants) && p.variants.length;

    let variantId = null;
    let pieces = null;
    let unitPrice = 0;
    let files = [];

    if(hasVariants){
      variantId = document.getElementById(`size_${p.id}`)?.value || p.variants[0].id;
      pieces = Number(document.getElementById(`pieces_${p.id}`)?.value || (p.pieces?.[0]||1));
      unitPrice = getVariantPrice(p, variantId, pieces);

      if(p.requiresFiles){
        const fileInput = document.getElementById(`files_${p.id}`);
        files = Array.from(fileInput?.files || []);
        if(files.length !== pieces){
          alert(t("filesNeed"));
          return;
        }
      }
    } else {
      unitPrice = Number(p.price || 0);
    }

    const name = p.name || { ar:p.id, en:p.id };
    const vObj = hasVariants ? p.variants.find(v=>v.id===variantId) : null;
    const variantLabel = vObj ? (state.lang==="ar" ? (vObj.ar||vObj.en||vObj.id) : (vObj.en||vObj.ar||vObj.id)) : null;

    const fileNames = files.map(f=>f.name); // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø®Ø²Ù† Ø£Ø³Ù…Ø§Ø¡ ÙÙ‚Ø· (Ù„ÙŠØ³ Ø§Ù„Ù…Ù„ÙØ§Øª Ù†ÙØ³Ù‡Ø§)

    const key = cartKey(p.id, variantId, pieces, fileNames.length);

    const existing = state.cart.find(i=>i.key===key && JSON.stringify(i.fileNames||[])===JSON.stringify(fileNames||[]));
    if(existing){
      existing.qty += 1;
    } else {
      state.cart.push({
        key,
        id: p.id,
        name,
        category: p.category || "",
        qty: 1,
        unitPrice: Number(unitPrice || 0),
        variantId,
        variantLabel,
        pieces,
        fileNames
      });
    }

    save();
    updateCartUI();
    openCart();
  }

  function updateCartUI(){
    const count = state.cart.reduce((s,i)=> s + Number(i.qty||0), 0);
    $("#count").textContent = count;

    const total = state.cart.reduce((s,i)=> s + (Number(i.unitPrice||0) * Number(i.qty||0)), 0);
    $("#total").textContent = money(total);

    const box = $("#items");
    const err = $("#cartErr");
    err.style.display="none";
    err.textContent="";

    if(!state.cart.length){
      box.innerHTML = `<div class="sub">${t("empty")}</div>`;
      return;
    }

    box.innerHTML = state.cart.map((i,idx)=>{
      const title = (i.name?.[state.lang] || i.name?.en || i.id);
      const metaParts = [];
      if(i.variantLabel) metaParts.push(`${t("size")}: ${i.variantLabel}`);
      if(i.pieces) metaParts.push(`${t("pieces")}: ${i.pieces}`);
      if(Array.isArray(i.fileNames) && i.fileNames.length) metaParts.push(`Files: ${i.fileNames.length}/${i.pieces||i.fileNames.length}`);

      const meta = metaParts.length ? metaParts.join(" â€¢ ") : "";
      const line = money(Number(i.unitPrice||0) * Number(i.qty||0));

      return `
        <div class="cartItem" data-idx="${idx}">
          <div class="ciTop">
            <div>
              <div class="ciName">${title}</div>
              ${meta ? `<div class="ciMeta">${meta}</div>` : ``}
            </div>
            <div class="ciPrice">${line}</div>
          </div>

          <div class="qtyRow">
            <button class="delBtn" data-del="${idx}">${t("remove")}</button>

            <button class="miniBtn" data-minus="${idx}" aria-label="minus">âˆ’</button>
            <input class="qtyInput" type="number" min="1" step="1" value="${Number(i.qty||1)}" data-qty="${idx}" />
            <button class="miniBtn" data-plus="${idx}" aria-label="plus">+</button>

            <span class="sub" style="margin-inline-start:auto">${money(i.unitPrice)} Ã— ${i.qty}</span>
          </div>
        </div>
      `;
    }).join("");

    // âœ… Event delegation (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø³Ù„Ø© ØªØªØ¹Ø§Ø¯ Ø±Ø³Ù…Ù‡Ø§ 100 Ù…Ø±Ø©ØŒ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ´ØªØºÙ„)
    box.onclick = (ev)=>{
      const plus = ev.target.closest("[data-plus]");
      const minus = ev.target.closest("[data-minus]");
      const del = ev.target.closest("[data-del]");
      if(!plus && !minus && !del) return;

      if(plus){
        const idx = Number(plus.dataset.plus);
        state.cart[idx].qty = Number(state.cart[idx].qty||1) + 1;
        save(); updateCartUI();
      }
      if(minus){
        const idx = Number(minus.dataset.minus);
        const q = Number(state.cart[idx].qty||1) - 1;
        state.cart[idx].qty = Math.max(1, q);
        save(); updateCartUI();
      }
      if(del){
        const idx = Number(del.dataset.del);
        state.cart.splice(idx,1);
        save(); updateCartUI();
      }
    };

    // direct typing quantity
    box.oninput = (ev)=>{
      const q = ev.target.closest("[data-qty]");
      if(!q) return;
      const idx = Number(q.dataset.qty);
      const val = Math.max(1, Number(q.value||1));
      state.cart[idx].qty = val;
      save(); updateCartUI();
    };
  }

  function openCart(){
    $("#drawer").classList.add("open");
  }
  function closeCart(){
    $("#drawer").classList.remove("open");
  }

  async function payNow(){
    try{
      $("#cartErr").style.display="none";
      $("#cartErr").textContent="";

      if(!state.cart.length){ openCart(); return; }

      // Validate magnet file requirements again before payment
      for(const i of state.cart){
        if(i.category==="magnet"){
          const need = Number(i.pieces||0);
          const have = Array.isArray(i.fileNames) ? i.fileNames.length : 0;
          if(need && have !== need){
            throw new Error(state.lang==="ar"
              ? `Ù…Ù†ØªØ¬ Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ ÙŠØ­ØªØ§Ø¬ ${need} ØµÙˆØ±.`
              : `Magnet product requires ${need} photos.`);
          }
        }
      }

      const items = state.cart.map(i=>{
        const title = (i.name?.[state.lang] || i.name?.en || i.id);
        const opt = [];
        if(i.variantLabel) opt.push(`${t("size")}: ${i.variantLabel}`);
        if(i.pieces) opt.push(`${t("pieces")}: ${i.pieces}`);
        if(Array.isArray(i.fileNames) && i.fileNames.length) opt.push(`Files: ${i.fileNames.length}`);
        const label = opt.length ? `${title} â€” ${opt.join(" â€” ")}` : title;

        return {
          name: String(label),
          unit_amount: Number(i.unitPrice || 0),
          quantity: Number(i.qty || 1)
        };
      });

      const res = await fetch(`${WORKER_URL}/create-checkout-session`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ currency:"AED", lang: state.lang, items })
      });

      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); } catch { data = { raw:text }; }

      if(!res.ok) throw new Error(data?.error || data?.raw || ("Worker error " + res.status));
      if(!data.url) throw new Error("No checkout URL returned");

      // Stripe: redirect customer to Checkout Session URL (server returns session.url)
      // This is the documented flow. :contentReference[oaicite:1]{index=1}
      location.href = data.url;

    } catch(e){
      const msg = (e?.message || String(e));
      $("#cartErr").style.display="block";
      $("#cartErr").textContent = msg;
      alert(msg);
    }
  }

  function placeCOD(){
    if(!state.cart.length){ openCart(); return; }

    const lines = state.cart.map(i=>{
      const title = (i.name?.[state.lang] || i.name?.en || i.id);
      const opt = [];
      if(i.variantLabel) opt.push(`${t("size")}: ${i.variantLabel}`);
      if(i.pieces) opt.push(`${t("pieces")}: ${i.pieces}`);
      if(Array.isArray(i.fileNames) && i.fileNames.length) opt.push(`Files: ${i.fileNames.length}`);
      return `- ${title}${opt.length ? " ("+opt.join(", ")+")" : ""} x${i.qty}`;
    }).join("\n");

    const total = state.cart.reduce((s,i)=> s + (Number(i.unitPrice||0)*Number(i.qty||0)), 0);

    const msg = (state.lang==="ar")
      ? `Ø·Ù„Ø¨ COD Ù…Ù† Ù…ØªØ¬Ø± Ø£Ø²Ù„\n${lines}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${money(total)}`
      : `COD order from azl MG shop\n${lines}\nTotal: ${money(total)}`;

    window.open(`https://wa.me/${COD_WHATSAPP}?text=${encodeURIComponent(msg)}`,"_blank","noopener");
  }

  // Events (âœ… no overlay blocking)
  $("#langBtn").addEventListener("click", ()=>{
    state.lang = (state.lang==="ar") ? "en" : "ar";
    save();
    applyLang();
    renderCategories();
    renderProducts();
  });

  $("#cartBtn").addEventListener("click", openCart);
  $("#back").addEventListener("click", closeCart);
  $("#closeBtn").addEventListener("click", closeCart);
  $("#payBtn").addEventListener("click", payNow);
  $("#codBtn").addEventListener("click", placeCOD);

  // Boot
  (async ()=>{
    try{
      await loadProducts();
      applyLang();
      renderCategories();
      renderProducts();
    } catch(e){
      applyLang();
      const msg = t("loadErr") + (e?.message || e);
      $("#grid").innerHTML = `<div class="sub">${msg}</div>`;
      alert(msg);
    }
    updateCartUI();
  })();
</script>
</body>
</html>
