<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ØªØ¬Ø± Ø£Ø²Ù„ | azl MG shop</title>
  <style>
    :root{--line:#e5e7eb;--muted:#6b7280;--dark:#111827}
    body{font-family:system-ui;margin:0;background:#fff;color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 14px;z-index:10}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{font-weight:900}
    .btn{border:1px solid var(--dark);background:var(--dark);color:#fff;border-radius:999px;padding:10px 14px;cursor:pointer}
    .ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .card{border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .img{height:140px;background:#f3f4f6}
    .p{padding:12px;display:grid;gap:8px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .drawer{position:fixed;inset:0;pointer-events:none}
    .drawer.open{pointer-events:auto}
    .panel{position:absolute;inset-inline-end:0;top:0;bottom:0;width:min(420px,92vw);background:#fff;border-inline-start:1px solid var(--line);transform:translateX(110%);transition:.2s}
    html[dir="ltr"] .panel{transform:translateX(-110%)}
    .drawer.open .panel{transform:translateX(0)}
    .back{position:absolute;inset:0;background:rgba(0,0,0,.35);opacity:0;transition:.2s}
    .drawer.open .back{opacity:1}
    .head{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .body{padding:14px;overflow:auto;max-height:calc(100vh - 180px)}
    .foot{padding:14px;border-top:1px solid var(--line)}
    @media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
    select{padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff}
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand" id="brand">Ù…ØªØ¬Ø± Ø£Ø²Ù„</div>
    <div class="row">
      <button class="btn ghost" id="langBtn">EN</button>
      <button class="btn ghost" id="cartBtn">ğŸ›’ <span id="count">0</span></button>
    </div>
  </div>
  <div class="muted" id="hint" style="margin-top:10px">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
</header>

<main class="wrap">
  <section class="grid" id="grid"></section>
</main>

<aside class="drawer" id="drawer" aria-hidden="true">
  <div class="panel">
    <div class="head">
      <b id="cartTitle">Ø³Ù„ØªÙƒ</b>
      <button class="btn ghost" id="close">âœ•</button>
    </div>

    <div class="body" id="items"></div>

    <div class="foot">
      <div class="row" style="justify-content:space-between">
        <span id="totalLabel">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
        <b id="total">AED 0.00</b>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="payBtn">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
        <button class="btn ghost" id="codBtn">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)</button>
      </div>

      <div class="muted" style="margin-top:10px" id="note">COD: Ø³Ù†Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†.</div>
    </div>
  </div>
  <div class="back" id="back"></div>
</aside>

<script>
  // Worker API (Stripe)
  const WORKER_URL = "https://azlshop.eng-suwan.workers.dev";

  // COD WhatsApp
  const COD_WHATSAPP = "971544219984";

  const dict = {
    ar: { brand:"Ù…ØªØ¬Ø± Ø£Ø²Ù„", hint:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", cart:"Ø³Ù„ØªÙƒ", total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", pay:"Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†", cod:"Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)", note:"COD: Ø³Ù†Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†.",
          add:"Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©", empty:"Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©.", size:"Ø§Ù„Ø­Ø¬Ù…", pieces:"Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹" },
    en: { brand:"azl MG shop", hint:"Latest products", cart:"Your cart", total:"Total", pay:"Pay now", cod:"Cash on Delivery (COD)", note:"COD: we will place the order without payment.",
          add:"Add to cart", empty:"Your cart is empty.", size:"Size", pieces:"Pieces" }
  };

  function detectDeviceLang(){
    const l = (navigator.language || "en").toLowerCase();
    return l.startsWith("ar") ? "ar" : "en";
  }

  const state = {
    lang: localStorage.getItem("azl_lang") || detectDeviceLang(),
    cart: JSON.parse(localStorage.getItem("azl_cart") || "[]"),
    products: [
      {
        id:"p1", cat:"print",
        name:{ ar:"Ù…Ù†ØªØ¬ Ø·Ø¨Ø§Ø¹Ø©", en:"Print Product" },
        options: {
          size: [
            { key:"size1", ar:"Ø­Ø¬Ù… 1", en:"Size 1", price: 49.00 },
            { key:"size2", ar:"Ø­Ø¬Ù… 2", en:"Size 2", price: 59.00 }
          ],
          pieces: [1,2]
        }
      },
      {
        id:"p2", cat:"basic",
        name:{ ar:"Ù…Ù†ØªØ¬ Ø¹Ø§Ø¯ÙŠ", en:"Basic Product" },
        options: null,
        price: 25.00
      }
    ]
  };

  const $ = (s)=>document.querySelector(s);
  function t(k){ return dict[state.lang][k]; }
  function money(x){ return `AED ${Number(x).toFixed(2)}`; }

  function save(){
    localStorage.setItem("azl_lang", state.lang);
    localStorage.setItem("azl_cart", JSON.stringify(state.cart));
  }

  function applyLang(){
    document.documentElement.lang = state.lang;
    document.documentElement.dir = state.lang==="ar" ? "rtl" : "ltr";
    $("#brand").textContent = t("brand");
    $("#hint").textContent = t("hint");
    $("#cartTitle").textContent = t("cart");
    $("#totalLabel").textContent = t("total");
    $("#payBtn").textContent = t("pay");
    $("#codBtn").textContent = t("cod");
    $("#note").textContent = t("note");
    $("#langBtn").textContent = state.lang==="ar" ? "EN" : "AR";
    render();
  }

  // Make add() available for inline onclick
  window.add = function add(id){
    const p = state.products.find(x=>x.id===id);
    if(!p) return;

    if (p.options?.size?.length){
      const sizeKey = document.getElementById(`size_${id}`)?.value;
      const pieces = Number(document.getElementById(`pieces_${id}`)?.value || 1);
      const sizeObj = p.options.size.find(s=>s.key===sizeKey);
      const sizeLabel = state.lang==="ar" ? sizeObj.ar : sizeObj.en;
      const unitPrice = Number(sizeObj.price);

      const key = `${id}|${sizeKey}|${pieces}`;
      const it = state.cart.find(x=>x.key===key);
      if(it) it.qty++;
      else state.cart.push({ key, id, name:p.name, qty:1, unitPrice, options:{ sizeLabel, pieces }});
    } else {
      const unitPrice = Number(p.price || 0);
      const key = `${id}|-|-`;
      const it = state.cart.find(x=>x.key===key);
      if(it) it.qty++;
      else state.cart.push({ key, id, name:p.name, qty:1, unitPrice, options:null });
    }

    save(); updateCartUI();
  }

  function render(){
    $("#grid").innerHTML = state.products.map(p=>`
      <article class="card">
        <div class="img"></div>
        <div class="p">
          <b>${p.name[state.lang]}</b>

          ${p.options?.size ? `
            <div class="row" style="gap:8px">
              <select id="size_${p.id}">
                ${p.options.size.map(s=>`
                  <option value="${s.key}">
                    ${state.lang==='ar'?s.ar:s.en} â€” ${money(s.price)}
                  </option>
                `).join("")}
              </select>
              <select id="pieces_${p.id}">
                ${p.options.pieces.map(n=>`
                  <option value="${n}">
                    ${t("pieces")}: ${n}
                  </option>
                `).join("")}
              </select>
            </div>
          ` : `<div class="muted">${money(p.price)}</div>`}

          <div class="row" style="justify-content:space-between">
            <button class="btn ghost" onclick="add('${p.id}')">${t("add")}</button>
          </div>
        </div>
      </article>
    `).join("");

    updateCartUI();
  }

  function updateCartUI(){
    $("#count").textContent = state.cart.reduce((s,i)=>s+i.qty,0);
    const total = state.cart.reduce((s,i)=> s + (i.unitPrice * i.qty), 0);
    $("#total").textContent = money(total);

    const box = $("#items");
    if(!state.cart.length){
      box.innerHTML = `<div class="muted">${t("empty")}</div>`;
      return;
    }
    box.innerHTML = state.cart.map(i=>{
      const opt = i.options ? ` â€¢ ${t("size")}: ${i.options.sizeLabel} â€¢ ${t("pieces")}: ${i.options.pieces}` : "";
      return `
        <div class="card" style="margin-bottom:10px">
          <div class="p">
            <b>${(i.name[state.lang]||i.name.en)}${opt}</b>
            <div class="row" style="justify-content:space-between">
              <span>${money(i.unitPrice)} Ã— ${i.qty}</span>
              <span class="muted">${money(i.unitPrice*i.qty)}</span>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  function openCart(){ $("#drawer").classList.add("open"); }
  function closeCart(){ $("#drawer").classList.remove("open"); }

  async function payNow(){
    try {
      if(!state.cart.length){ openCart(); return; }

      const items = state.cart.map(i => {
        const opt = i.options
          ? ` â€” ${t("size")}: ${i.options.sizeLabel} â€” ${t("pieces")}: ${i.options.pieces}`
          : "";
        return {
          name: String((i.name[state.lang] || i.name.en) + opt),
          unit_amount: Number(i.unitPrice),
          quantity: Number(i.qty)
        };
      });

      const res = await fetch(`${WORKER_URL}/create-checkout-session`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ lang: state.lang, currency:"AED", items })
      });

      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      if(!res.ok){
        alert(`Worker error (${res.status}): ` + (data.error || data.raw || "Unknown error"));
        return;
      }
      if(!data.url){
        alert("Worker returned no checkout url. Response: " + JSON.stringify(data));
        return;
      }

      window.location.href = data.url;
    } catch (e) {
      alert("Pay now failed: " + (e?.message || e));
    }
  }

  function placeCOD(){
    const total = state.cart.reduce((s,i)=> s + (i.unitPrice*i.qty), 0);
    const lines = state.cart.map(i=>{
      const n = (i.name[state.lang]||i.name.en);
      const opt = i.options ? ` (${i.options.sizeLabel}, ${t("pieces")}: ${i.options.pieces})` : "";
      return `- ${n}${opt} x${i.qty} = ${money(i.unitPrice*i.qty)}`;
    }).join("%0A");

    const msg = state.lang==="ar"
      ? `Ø·Ù„Ø¨ COD Ù…Ù† Ù…ØªØ¬Ø± Ø£Ø²Ù„%0A${lines}%0AØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${money(total)}`
      : `COD order from azl MG shop%0A${lines}%0ATotal: ${money(total)}`;

    window.open(`https://wa.me/${COD_WHATSAPP}?text=${msg}`,"_blank","noopener");
  }

  $("#langBtn").addEventListener("click", ()=>{
    state.lang = state.lang==="ar" ? "en" : "ar";
    save(); applyLang();
  });
  $("#cartBtn").addEventListener("click", openCart);
  $("#close").addEventListener("click", closeCart);
  $("#back").addEventListener("click", closeCart);
$("#payBtn").addEventListener("click", () => {
  alert("Pay Now clicked âœ…");
  payNow();
});
  $("#codBtn").addEventListener("click", placeCOD);

  applyLang();
</script>
</body>
</html>

